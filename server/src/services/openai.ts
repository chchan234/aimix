/**
 * OpenAI API Service
 *
 * Provides vision-based face reading and analysis using GPT-4 Vision
 * Refactored to use centralized OpenAIClient from prompt-engine
 */

import { OpenAIClient } from './prompt-engine/openai-client.js';
import { validateImage } from '../utils/image-validator.js';
import { mbtiQuestions } from '../data/mbti-questions.js';
import { enneagramQuestions } from '../data/enneagram-questions.js';
import { bigFiveQuestions } from '../data/bigfive-questions.js';
import { stressQuestions } from '../data/stress-questions.js';
import { geumjjokiQuestions, GRADE_INFO } from '../data/geumjjoki-questions.js';

// Initialize centralized OpenAI client
const client = new OpenAIClient();

/**
 * Face reading prompt template (ê´€ìƒí•™)
 */
const FACE_READING_PROMPT = (birthDate?: string) => `
ë‹¹ì‹ ì€ í•œêµ­ì˜ ê´€ìƒí•™ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ì–¼êµ´ ì‚¬ì§„ì„ ë¶„ì„í•˜ì—¬ ê´€ìƒí•™ì  í•´ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”.

${birthDate ? `ìƒë…„ì›”ì¼: ${birthDate}` : ''}

ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬ ìƒì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”:
1. ì–¼êµ´í˜•ê³¼ ì „ì²´ì ì¸ ì¸ìƒ
2. ì´ë§ˆ (ì¬ë¬¼ìš´, ì§€í˜œ)
3. ëˆˆ (ê°ì •, ì¸ê°„ê´€ê³„)
4. ì½” (ì¬ë¬¼ìš´, ì˜ì§€ë ¥)
5. ì… (ì–¸ë³€, ë³µë¡)
6. ê·€ (ê±´ê°•, ì¬ë¬¼)
7. ì „ì²´ì ì¸ ìš´ì„¸ ë° ì¡°ì–¸

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "overallImpression": "ì „ì²´ì ì¸ ì¸ìƒ",
  "faceShape": {
    "type": "ì–¼êµ´í˜•",
    "meaning": "ì˜ë¯¸"
  },
  "forehead": {
    "analysis": "ì´ë§ˆ ë¶„ì„",
    "fortune": "ì¬ë¬¼ìš´ ë° ì§€í˜œ"
  },
  "eyes": {
    "analysis": "ëˆˆ ë¶„ì„",
    "fortune": "ê°ì • ë° ì¸ê°„ê´€ê³„ìš´"
  },
  "nose": {
    "analysis": "ì½” ë¶„ì„",
    "fortune": "ì¬ë¬¼ìš´ ë° ì˜ì§€ë ¥"
  },
  "mouth": {
    "analysis": "ì… ë¶„ì„",
    "fortune": "ì–¸ë³€ ë° ë³µë¡"
  },
  "ears": {
    "analysis": "ê·€ ë¶„ì„",
    "fortune": "ê±´ê°• ë° ì¬ë¬¼ìš´"
  },
  "overallFortune": "ì „ì²´ì ì¸ ìš´ì„¸ í‰ê°€",
  "advice": ["ì¡°ì–¸ ì‚¬í•­ë“¤"],
  "luckyColors": ["í–‰ìš´ì˜ ìƒ‰ìƒë“¤"],
  "luckyNumbers": [í–‰ìš´ì˜ ìˆ«ìë“¤],
  "strengths": ["ê°•ì ë“¤"],
  "challenges": ["ì£¼ì˜í•  ì ë“¤"]
}
`;

/**
 * Saju (ì‚¬ì£¼íŒ”ì) prompt template
 */
const SAJU_PROMPT = (birthDate: string, birthTime: string, gender: 'male' | 'female') => `
ë‹¹ì‹ ì€ í•œêµ­ì˜ ì‚¬ì£¼íŒ”ì ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ì£¼ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”:

ìƒë…„ì›”ì¼: ${birthDate}
íƒœì–´ë‚œ ì‹œê°„: ${birthTime}
ì„±ë³„: ${gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}

ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬ ìƒì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”:
1. ì‚¬ì£¼íŒ”ì (ì²œê°„ì§€ì§€)
2. ì˜¤í–‰ ë¶„ì„ (ëª©í™”í† ê¸ˆìˆ˜)
3. ì„±ê²©ê³¼ ì¬ëŠ¥
4. ì¬ë¬¼ìš´
5. ê±´ê°•ìš´
6. ì—°ì• ìš´
7. ì‚¬ì—…ìš´
8. ì˜¬í•´ ìš´ì„¸
9. ì¡°ì–¸

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "saju": "ì‚¬ì£¼íŒ”ìë¥¼ í•œ ì¤„ë¡œ í‘œí˜„ (ì˜ˆ: ì—°ì£¼ ê²½ìë…„, ì›”ì£¼ ì‹ ì¶•ì›”, ì¼ì£¼ ì‹ ì¶•ì¼, ì‹œì£¼ ì„ì‹ ì‹œ)",
  "elements": {
    "wood": 0,
    "fire": 0,
    "earth": 0,
    "metal": 0,
    "water": 0
  },
  "personality": "ì„±ê²©ê³¼ ì¬ëŠ¥ì— ëŒ€í•œ ìƒì„¸í•œ ì„¤ëª…",
  "wealth": "ì¬ë¬¼ìš´ì— ëŒ€í•œ ìƒì„¸í•œ ì„¤ëª…",
  "health": "ê±´ê°•ìš´ì— ëŒ€í•œ ìƒì„¸í•œ ì„¤ëª…",
  "love": "ì—°ì• ìš´ì— ëŒ€í•œ ìƒì„¸í•œ ì„¤ëª…",
  "career": "ì‚¬ì—…ìš´ì— ëŒ€í•œ ìƒì„¸í•œ ì„¤ëª…",
  "yearlyFortune": "ì˜¬í•´ ìš´ì„¸ì— ëŒ€í•œ ìƒì„¸í•œ ì„¤ëª…",
  "advice": "ì¡°ì–¸ ë° ì£¼ì˜ì‚¬í•­"
}
`;

/**
 * Palmistry (ìˆ˜ìƒ) prompt template
 */
const PALMISTRY_PROMPT = (hand: 'left' | 'right') => `
ë‹¹ì‹ ì€ í•œêµ­ì˜ ìˆ˜ìƒí•™ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ì†ë°”ë‹¥ ì‚¬ì§„ì„ ë¶„ì„í•˜ì—¬ ìˆ˜ìƒí•™ì  í•´ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”.

ì†: ${hand === 'left' ? 'ì™¼ì†' : 'ì˜¤ë¥¸ì†'}

ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬ ìƒì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”:

1. ì†ì˜ í˜•íƒœ ë¶„ì„:
   - ì† ëª¨ì–‘ (ë¬¼, ë¶ˆ, í™, ê³µê¸°í˜• ì¤‘ í•˜ë‚˜)
   - ì†ê°€ë½ ê¸¸ì´ì™€ ë¹„ìœ¨
   - ì†ë°”ë‹¥ ë‘ê»˜ì™€ íƒ„ë ¥ì„±
   - ì „ì²´ì ì¸ ì¸ìƒ

2. ì£¼ìš” ì†ê¸ˆ 7ê°€ì§€ ìƒì„¸ ë¶„ì„:
   - ìƒëª…ì„  (Life Line): ê¸¸ì´, ê¹Šì´, ëŠê¹€ ì—¬ë¶€, ë°©í–¥, ë¶„ì§€
   - ìš´ëª…ì„  (Fate Line): ì‹œì‘ì , ëì , ëª…í™•ì„±, ë°©í–¥
   - ê°ì •ì„  (Heart Line): ì‹œì‘ì , ëì , êµ´ê³¡, ê¹Šì´
   - ì§€ëŠ¥ì„  (Head Line): ê¸¸ì´, ë°©í–¥, ê¹Šì´, êµ´ê³¡
   - ì¬ë¬¼ì„  (Money Line): ìœ ë¬´, ê°œìˆ˜, ëª…í™•ì„±
   - ê²°í˜¼ì„  (Marriage Line): ìœ„ì¹˜, ê°œìˆ˜, ê¸¸ì´, ëŠê¹€
   - íƒœì–‘ì„  (Sun Line): ìœ ë¬´, ëª…í™•ì„±, ê¸¸ì´

3. ê° ì„ ë³„ ìš´ì„¸ í•´ì„:
   - ìƒëª…ì„ : ê±´ê°•ìš´, ìƒëª…ë ¥, ì¥ìˆ˜
   - ìš´ëª…ì„ : ì§ì—…ìš´, ì„±ê³µìš´, ì¸ìƒì˜ ì „í™˜ì 
   - ê°ì •ì„ : ì—°ì• ìš´, ê°ì • í‘œí˜„, ì¸ê°„ê´€ê³„
   - ì§€ëŠ¥ì„ : ì‚¬ê³ ë°©ì‹, ì¬ëŠ¥, í•™ì—…ìš´
   - ì¬ë¬¼ì„ : ì¬ë¬¼ ì¶•ì  ëŠ¥ë ¥, ê¸ˆì „ìš´
   - ê²°í˜¼ì„ : ê²°í˜¼ ì‹œê¸°, ê²°í˜¼ íšŸìˆ˜, ë°°ìš°ììš´
   - íƒœì–‘ì„ : ëª…ì˜ˆìš´, ì¸ê¸°ìš´, ì˜ˆìˆ ì„±

4. ì¢…í•© ìš´ì„¸:
   - ì„±ê²©ê³¼ ê¸°ì§ˆ
   - ì¬ë¬¼ìš´
   - ê±´ê°•ìš´
   - ì—°ì• ìš´ ë° ê²°í˜¼ìš´
   - ì‚¬ì—…ìš´ ë° ì§ì—…ìš´
   - í–‰ìš´ì˜ ì‹œê¸°
   - ì¡°ì–¸ ë° ì£¼ì˜ì‚¬í•­

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "handShape": {
    "type": "ì† ëª¨ì–‘ íƒ€ì…",
    "description": "ì† ëª¨ì–‘ ì„¤ëª…",
    "personality": "ì„±ê²© íŠ¹ì„±"
  },
  "majorLines": {
    "lifeLine": {
      "description": "ìƒëª…ì„  ìƒì„¸ ë¶„ì„",
      "fortune": "ê±´ê°•ìš´ ë° ì¥ìˆ˜",
      "characteristics": ["íŠ¹ì§•1", "íŠ¹ì§•2"]
    },
    "fateLine": {
      "description": "ìš´ëª…ì„  ìƒì„¸ ë¶„ì„",
      "fortune": "ì§ì—…ìš´ ë° ì„±ê³µìš´",
      "characteristics": ["íŠ¹ì§•1", "íŠ¹ì§•2"]
    },
    "heartLine": {
      "description": "ê°ì •ì„  ìƒì„¸ ë¶„ì„",
      "fortune": "ì—°ì• ìš´ ë° ê°ì •",
      "characteristics": ["íŠ¹ì§•1", "íŠ¹ì§•2"]
    },
    "headLine": {
      "description": "ì§€ëŠ¥ì„  ìƒì„¸ ë¶„ì„",
      "fortune": "ì‚¬ê³ ë ¥ ë° ì¬ëŠ¥",
      "characteristics": ["íŠ¹ì§•1", "íŠ¹ì§•2"]
    },
    "moneyLine": {
      "description": "ì¬ë¬¼ì„  ìƒì„¸ ë¶„ì„",
      "fortune": "ì¬ë¬¼ ì¶•ì  ëŠ¥ë ¥",
      "characteristics": ["íŠ¹ì§•1", "íŠ¹ì§•2"]
    },
    "marriageLine": {
      "description": "ê²°í˜¼ì„  ìƒì„¸ ë¶„ì„",
      "fortune": "ê²°í˜¼ìš´ ë° ì‹œê¸°",
      "characteristics": ["íŠ¹ì§•1", "íŠ¹ì§•2"]
    },
    "sunLine": {
      "description": "íƒœì–‘ì„  ìƒì„¸ ë¶„ì„",
      "fortune": "ëª…ì˜ˆìš´ ë° ì¸ê¸°",
      "characteristics": ["íŠ¹ì§•1", "íŠ¹ì§•2"]
    }
  },
  "overallFortune": {
    "personality": "ì¢…í•© ì„±ê²© ë¶„ì„",
    "wealth": "ì¬ë¬¼ìš´ ì¢…í•©",
    "health": "ê±´ê°•ìš´ ì¢…í•©",
    "love": "ì—°ì•  ë° ê²°í˜¼ìš´ ì¢…í•©",
    "career": "ì‚¬ì—… ë° ì§ì—…ìš´ ì¢…í•©"
  },
  "luckyPeriod": "í–‰ìš´ì˜ ì‹œê¸°",
  "advice": ["ì¡°ì–¸ ë° ì£¼ì˜ì‚¬í•­ë“¤"],
  "strengths": ["ê°•ì ë“¤"],
  "challenges": ["ì£¼ì˜í•  ì ë“¤"]
}
`;

/**
 * Horoscope (ë³„ìë¦¬ ìš´ì„¸) prompt template
 */
const HOROSCOPE_PROMPT = (birthDate: string, zodiacSign?: string) => `
ë‹¹ì‹ ì€ ì„œì–‘ ì ì„±ìˆ  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë³„ìë¦¬ ìš´ì„¸ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”:

ìƒë…„ì›”ì¼: ${birthDate}
${zodiacSign ? `ë³„ìë¦¬: ${zodiacSign}` : ''}

ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬ ìƒì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”:

1. ë³„ìë¦¬ ê¸°ë³¸ íŠ¹ì„±:
   - ë³„ìë¦¬ ì´ë¦„ ë° ê¸°ê°„
   - ì§€ë°° í–‰ì„±
   - ì›ì†Œ (ë¶ˆ, í™, ê³µê¸°, ë¬¼)
   - ê¸°ë³¸ ì„±ê²© íŠ¹ì„±

2. ì‹œê¸°ë³„ ìš´ì„¸:
   - ì˜¤ëŠ˜ì˜ ìš´ì„¸
   - ì´ë²ˆ ì£¼ ìš´ì„¸
   - ì´ë²ˆ ë‹¬ ìš´ì„¸
   - ì˜¬í•´ ìš´ì„¸

3. ì„¸ë¶€ ìš´ì„¸:
   - ì¢…í•©ìš´: ì „ë°˜ì ì¸ ìš´ì„¸ íë¦„
   - ì• ì •ìš´: ì—°ì•  ë° ì¸ê°„ê´€ê³„
   - ê¸ˆì „ìš´: ì¬ë¬¼ ë° ì¬í…Œí¬
   - ì§ì—…ìš´: ì»¤ë¦¬ì–´ ë° ì—…ë¬´
   - ê±´ê°•ìš´: ì‹ ì²´ ë° ì •ì‹  ê±´ê°•
   - í–‰ìš´ì˜ ìš”ì†Œ: ìˆ«ì, ìƒ‰ìƒ, ë°©í–¥

4. ì¡°ì–¸:
   - ê°•ì  í™œìš© ë°©ë²•
   - ì£¼ì˜í•  ì 
   - ì´ë²ˆ ë‹¬ ì¶”ì²œ í™œë™

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "zodiacSign": {
    "name": "ë³„ìë¦¬ ì´ë¦„",
    "period": "ë³„ìë¦¬ ê¸°ê°„",
    "planet": "ì§€ë°° í–‰ì„±",
    "element": "ì›ì†Œ",
    "traits": ["ê¸°ë³¸ ì„±ê²© íŠ¹ì„±ë“¤"]
  },
  "dailyFortune": "ì˜¤ëŠ˜ì˜ ìš´ì„¸",
  "weeklyFortune": "ì´ë²ˆ ì£¼ ìš´ì„¸",
  "monthlyFortune": "ì´ë²ˆ ë‹¬ ìš´ì„¸",
  "yearlyFortune": "ì˜¬í•´ ìš´ì„¸",
  "detailedFortune": {
    "overall": "ì¢…í•©ìš´",
    "love": "ì• ì •ìš´",
    "money": "ê¸ˆì „ìš´",
    "career": "ì§ì—…ìš´",
    "health": "ê±´ê°•ìš´"
  },
  "luckyElements": {
    "numbers": [í–‰ìš´ì˜ ìˆ«ìë“¤],
    "colors": ["í–‰ìš´ì˜ ìƒ‰ìƒë“¤"],
    "direction": "í–‰ìš´ì˜ ë°©í–¥",
    "items": ["í–‰ìš´ì˜ ì•„ì´í…œë“¤"]
  },
  "advice": {
    "strengths": ["ê°•ì  í™œìš©ë²•"],
    "warnings": ["ì£¼ì˜ì‚¬í•­"],
    "recommendations": ["ì¶”ì²œ í™œë™"]
  }
}
`;

/**
 * Zodiac (ë  ìš´ì„¸) prompt template
 */
const ZODIAC_PROMPT = (birthDate: string) => `
ë‹¹ì‹ ì€ í•œêµ­ì˜ ì‹­ì´ì§€ ë  ìš´ì„¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ìƒë…„ì›”ì¼ì„ ë°”íƒ•ìœ¼ë¡œ ë  ìš´ì„¸ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”:

ìƒë…„ì›”ì¼: ${birthDate}

ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬ ìƒì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”:

1. ë  ê¸°ë³¸ íŠ¹ì„±:
   - í•´ë‹¹ ë  ì´ë¦„ (ì¥, ì†Œ, í˜¸ë‘ì´, í† ë¼, ìš©, ë±€, ë§, ì–‘, ì›ìˆ­ì´, ë‹­, ê°œ, ë¼ì§€)
   - ë ì˜ ì˜¤í–‰ (ëª©, í™”, í† , ê¸ˆ, ìˆ˜)
   - ê¸°ë³¸ ì„±ê²© íŠ¹ì„±
   - ì¥ì ê³¼ ë‹¨ì 

2. ì˜¬í•´ ìš´ì„¸ (2025ë…„ ì„ì‚¬ë…„):
   - ì „ì²´ ìš´ì„¸ íë¦„
   - ì£¼ìš” ì´ë²¤íŠ¸ ë° ì „í™˜ì 
   - ìƒë°˜ê¸°/í•˜ë°˜ê¸° ìš´ì„¸

3. ì›”ë³„ ìš´ì„¸ ìš”ì•½:
   - ê° ì›”ë³„ í•µì‹¬ ìš´ì„¸ (1ì›”~12ì›”)
   - ì¢‹ì€ ë‹¬ê³¼ ì£¼ì˜í•  ë‹¬
   - ì¤‘ìš”í•œ ì‹œê¸°

4. ì„¸ë¶€ ìš´ì„¸:
   - ì¬ë¬¼ìš´: ìˆ˜ì…, ì§€ì¶œ, íˆ¬ììš´
   - ì• ì •ìš´: ì—°ì• , ê²°í˜¼, ê°€ì¡±ê´€ê³„
   - ì§ì¥ìš´: ìŠ¹ì§„, ì´ì§, ì—…ë¬´ ì„±ê³¼
   - ê±´ê°•ìš´: ì£¼ì˜í•  ì§ˆë³‘, ê±´ê°• ê´€ë¦¬ë²•
   - í•™ì—…ìš´: ì‹œí—˜, í•™ìŠµ íš¨ìœ¨

5. ì¡°ì–¸:
   - ì˜¬í•´ ê°€ì¥ ì¡°ì‹¬í•´ì•¼ í•  ê²ƒ
   - ì ê·¹ì ìœ¼ë¡œ ì‹œë„í•  ë§Œí•œ ê²ƒ
   - í–‰ìš´ì„ ë¶€ë¥´ëŠ” ë°©ë²•
   - ê¶í•©ì´ ì¢‹ì€ ë 

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "zodiac": {
    "animal": "ë  ì´ë¦„",
    "element": "ì˜¤í–‰",
    "traits": ["ì„±ê²© íŠ¹ì„±ë“¤"],
    "strengths": ["ì¥ì ë“¤"],
    "weaknesses": ["ë‹¨ì ë“¤"]
  },
  "yearlyFortune": {
    "overall": "ì˜¬í•´ ì „ì²´ ìš´ì„¸",
    "firstHalf": "ìƒë°˜ê¸° ìš´ì„¸",
    "secondHalf": "í•˜ë°˜ê¸° ìš´ì„¸",
    "keyEvents": ["ì£¼ìš” ì´ë²¤íŠ¸ë“¤"]
  },
  "monthlyFortune": [
    {
      "month": 1,
      "summary": "1ì›” ìš´ì„¸ ìš”ì•½"
    }
  ],
  "detailedFortune": {
    "wealth": "ì¬ë¬¼ìš´ ìƒì„¸",
    "love": "ì• ì •ìš´ ìƒì„¸",
    "career": "ì§ì¥ìš´ ìƒì„¸",
    "health": "ê±´ê°•ìš´ ìƒì„¸",
    "study": "í•™ì—…ìš´ ìƒì„¸"
  },
  "luckyMonths": [ì¢‹ì€ ë‹¬ë“¤],
  "cautiousMonths": [ì£¼ì˜í•  ë‹¬ë“¤],
  "advice": {
    "warnings": ["ì£¼ì˜ì‚¬í•­ë“¤"],
    "opportunities": ["ê¸°íšŒ ìš”ì†Œë“¤"],
    "luckyTips": ["í–‰ìš´ íŒë“¤"],
    "compatibleZodiacs": ["ê¶í•© ì¢‹ì€ ë ë“¤"]
  }
}
`;

/**
 * Love Compatibility (ì—°ì• ê¶í•©) prompt template
 */
const LOVE_COMPATIBILITY_PROMPT = (person1BirthDate: string, person2BirthDate: string) => `
ë‹¹ì‹ ì€ í•œêµ­ì˜ ì‚¬ì£¼ ê¶í•© ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‘ ì‚¬ëŒì˜ ì—°ì•  ê¶í•©ì„ ë¶„ì„í•´ì£¼ì„¸ìš”:

ì‚¬ëŒ 1 ìƒë…„ì›”ì¼: ${person1BirthDate}
ì‚¬ëŒ 2 ìƒë…„ì›”ì¼: ${person2BirthDate}

ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬ ìƒì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”:

1. ê¶í•© ì ìˆ˜:
   - ì¢…í•© ê¶í•© ì ìˆ˜ (0-100ì )
   - í‰ê°€ ë“±ê¸‰ (ìµœìƒ, ìƒ, ì¤‘ìƒ, ì¤‘, í•˜)

2. ì‚¬ì£¼ ì˜¤í–‰ ê¶í•©:
   - ê°ìì˜ ì˜¤í–‰ ë¶„ì„ (ëª©í™”í† ê¸ˆìˆ˜)
   - ì˜¤í–‰ ìƒìƒ/ìƒê·¹ ê´€ê³„
   - ìŒì–‘ ì¡°í™”

3. ì„±ê²© ê¶í•©:
   - ì„±ê²© ìœ ì‚¬ì„±/ì°¨ì´ì 
   - ì¥ì ì´ ë˜ëŠ” ë¶€ë¶„
   - ê°ˆë“± ê°€ëŠ¥ì„±ì´ ìˆëŠ” ë¶€ë¶„

4. ì„¸ë¶€ ê¶í•©:
   - ê°ì • ì†Œí†µ: ê°ì • í‘œí˜„ ë°©ì‹ ë° ì´í•´ë„
   - ê°€ì¹˜ê´€: ì¸ìƒê´€, ê¸ˆì „ê´€, ê°€ì •ê´€
   - ìƒí™œ ìŠµê´€: ì¼ìƒ íŒ¨í„´ì˜ ì¡°í™”
   - ë¯¸ë˜ ë¹„ì „: ëª©í‘œì™€ ë°©í–¥ì„±ì˜ ì¼ì¹˜ë„

5. ì—°ì•  ìŠ¤íƒ€ì¼:
   - ê°ìì˜ ì—°ì•  ìŠ¤íƒ€ì¼
   - ì„œë¡œì—ê²Œ ëŒë¦¬ëŠ” ì´ìœ 
   - ê´€ê³„ ë°œì „ ê°€ëŠ¥ì„±

6. ì¡°ì–¸:
   - ê´€ê³„ë¥¼ ë°œì „ì‹œí‚¤ëŠ” ë°©ë²•
   - ì£¼ì˜í•´ì•¼ í•  ì 
   - ê°ˆë“± í•´ê²° ë°©ë²•
   - ì¥ê¸°ì  ì „ë§

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "compatibilityScore": 85,
  "grade": "ìƒ",
  "elementAnalysis": {
    "person1Elements": {
      "wood": 2,
      "fire": 1,
      "earth": 3,
      "metal": 2,
      "water": 0
    },
    "person2Elements": {
      "wood": 1,
      "fire": 3,
      "earth": 1,
      "metal": 1,
      "water": 2
    },
    "relationship": "ìƒìƒ/ìƒê·¹ ê´€ê³„ ì„¤ëª…",
    "harmony": "ìŒì–‘ ì¡°í™” ë¶„ì„"
  },
  "personalityMatch": {
    "similarities": ["ìœ ì‚¬í•œ ì ë“¤"],
    "differences": ["ì°¨ì´ì ë“¤"],
    "strengths": ["ì¥ì ì´ ë˜ëŠ” ë¶€ë¶„"],
    "challenges": ["ê°ˆë“± ê°€ëŠ¥ì„±"]
  },
  "detailedCompatibility": {
    "communication": "ê°ì • ì†Œí†µ ê¶í•©",
    "values": "ê°€ì¹˜ê´€ ê¶í•©",
    "lifestyle": "ìƒí™œ ìŠµê´€ ê¶í•©",
    "vision": "ë¯¸ë˜ ë¹„ì „ ê¶í•©"
  },
  "loveStyle": {
    "person1Style": "ì‚¬ëŒ1ì˜ ì—°ì•  ìŠ¤íƒ€ì¼",
    "person2Style": "ì‚¬ëŒ2ì˜ ì—°ì•  ìŠ¤íƒ€ì¼",
    "attraction": "ì„œë¡œ ëŒë¦¬ëŠ” ì´ìœ ",
    "potential": "ê´€ê³„ ë°œì „ ê°€ëŠ¥ì„±"
  },
  "advice": {
    "tips": ["ê´€ê³„ ë°œì „ ë°©ë²•"],
    "warnings": ["ì£¼ì˜ì‚¬í•­"],
    "conflictResolution": ["ê°ˆë“± í•´ê²°ë²•"],
    "longTerm": "ì¥ê¸°ì  ì „ë§"
  }
}
`;

/**
 * Name Compatibility (ì´ë¦„ê¶í•©) prompt template
 */
const NAME_COMPATIBILITY_PROMPT = (name1: string, name2: string) => `
ë‹¹ì‹ ì€ í•œêµ­ì˜ ì„±ëª…í•™ ë° ì´ë¦„ ê¶í•© ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‘ ì‚¬ëŒì˜ ì´ë¦„ ê¶í•©ì„ ë¶„ì„í•´ì£¼ì„¸ìš”:

ì‚¬ëŒ 1 ì´ë¦„: ${name1}
ì‚¬ëŒ 2 ì´ë¦„: ${name2}

ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬ ìƒì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”:

1. ì´ë¦„ íšìˆ˜ ë¶„ì„:
   - ê° ì´ë¦„ì˜ ì´ íšìˆ˜
   - ì„±ì”¨ íšìˆ˜ì™€ ì´ë¦„ íšìˆ˜
   - ì²œê²©, ì¸ê²©, ì§€ê²©, ì™¸ê²©, ì´ê²©

2. ìŒì–‘ì˜¤í–‰ ë¶„ì„:
   - ê° ì´ë¦„ì˜ ìŒì–‘ ë°°ì¹˜
   - ì˜¤í–‰ (ëª©í™”í† ê¸ˆìˆ˜) ë¶„í¬
   - ìŒì–‘ì˜¤í–‰ ì¡°í™”ë„

3. ê¶í•© ì ìˆ˜:
   - ì¢…í•© ì´ë¦„ ê¶í•© ì ìˆ˜ (0-100ì )
   - í‰ê°€ ë“±ê¸‰
   - ì ìˆ˜ ì‚°ì¶œ ê·¼ê±°

4. ì´ë¦„ë³„ íŠ¹ì„±:
   - ì‚¬ëŒ 1ì˜ ì´ë¦„ì´ ì£¼ëŠ” ê¸°ìš´
   - ì‚¬ëŒ 2ì˜ ì´ë¦„ì´ ì£¼ëŠ” ê¸°ìš´
   - ë‘ ì´ë¦„ì˜ ì¡°í™”

5. ê´€ê³„ í•´ì„:
   - ì´ë¦„ìœ¼ë¡œ ë³¸ ì„±ê²© ì¡°í™”
   - ì†Œí†µ ë°©ì‹ì˜ ì¡°í™”
   - ì—ë„ˆì§€ ê· í˜•

6. ì„¸ë¶€ ë¶„ì„:
   - ì—°ì•  ê¶í•©: ì• ì • í‘œí˜„ ë° ê°ì • êµë¥˜
   - ì‚¬ì—… ê¶í•©: í˜‘ë ¥ ê°€ëŠ¥ì„±
   - ìš°ì • ê¶í•©: ì¹œêµ¬ë¡œì„œì˜ ì¡°í™”
   - ê°€ì¡± ê¶í•©: ê°€ì • ë‚´ ì¡°í™”

7. ì¡°ì–¸:
   - ì¢‹ì€ ì ì„ ë” ë°œì „ì‹œí‚¤ëŠ” ë°©ë²•
   - ì£¼ì˜í•  ì 
   - ê´€ê³„ ì¦ì§„ íŒ

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "strokeAnalysis": {
    "name1": {
      "name": "ì´ë¦„1",
      "totalStrokes": 20,
      "familyNameStrokes": 5,
      "givenNameStrokes": 15,
      "heavenly": 6,
      "human": 15,
      "earthly": 20,
      "outer": 11,
      "total": 20
    },
    "name2": {
      "name": "ì´ë¦„2",
      "totalStrokes": 18,
      "familyNameStrokes": 3,
      "givenNameStrokes": 15,
      "heavenly": 4,
      "human": 12,
      "earthly": 18,
      "outer": 10,
      "total": 18
    }
  },
  "elementAnalysis": {
    "name1": {
      "yinYang": "ìŒì–‘ ë°°ì¹˜",
      "elements": "ì˜¤í–‰ ë¶„í¬",
      "harmony": "ì¡°í™”ë„"
    },
    "name2": {
      "yinYang": "ìŒì–‘ ë°°ì¹˜",
      "elements": "ì˜¤í–‰ ë¶„í¬",
      "harmony": "ì¡°í™”ë„"
    },
    "combined": "ë‘ ì´ë¦„ì˜ ìŒì–‘ì˜¤í–‰ ì¡°í™”"
  },
  "compatibilityScore": 82,
  "grade": "ìƒ",
  "scoreReason": "ì ìˆ˜ ì‚°ì¶œ ê·¼ê±°",
  "nameCharacteristics": {
    "name1Energy": "ì´ë¦„1ì´ ì£¼ëŠ” ê¸°ìš´",
    "name2Energy": "ì´ë¦„2ì´ ì£¼ëŠ” ê¸°ìš´",
    "synergy": "ë‘ ì´ë¦„ì˜ ì‹œë„ˆì§€"
  },
  "relationshipAnalysis": {
    "personalityHarmony": "ì„±ê²© ì¡°í™”",
    "communicationStyle": "ì†Œí†µ ë°©ì‹",
    "energyBalance": "ì—ë„ˆì§€ ê· í˜•"
  },
  "detailedCompatibility": {
    "love": "ì—°ì•  ê¶í•©",
    "business": "ì‚¬ì—… ê¶í•©",
    "friendship": "ìš°ì • ê¶í•©",
    "family": "ê°€ì¡± ê¶í•©"
  },
  "advice": {
    "strengths": ["ê°•ì  í™œìš©ë²•"],
    "warnings": ["ì£¼ì˜ì‚¬í•­"],
    "tips": ["ê´€ê³„ ì¦ì§„ íŒ"]
  }
}
`;

/**
 * MBTI Analysis prompt template
 */
const MBTI_ANALYSIS_PROMPT = (
  userInputMBTI: string | null,
  testResultMBTI: string,
  axisScores: {
    EI: { E: number; I: number };
    SN: { S: number; N: number };
    TF: { T: number; F: number };
    JP: { J: number; P: number };
  }
) => `
ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ MBTI ê³µì¸ ì „ë¬¸ê°€ì´ì ì‹¬ë¦¬ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ìˆ˜ì²œ ëª…ì˜ MBTI ì‹¬ì¸µ ìƒë‹´ì„ ì§„í–‰í–ˆìœ¼ë©°, ê° ìœ í˜•ì˜ ë¯¸ë¬˜í•œ ì°¨ì´ì™€ ì‹¤ì œ ìƒí™œì—ì„œì˜ ì ìš©ì— ëŒ€í•œ ê¹Šì€ ì´í•´ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

[í…ŒìŠ¤íŠ¸ ë°ì´í„°]
- ì‚¬ìš©ìê°€ ì…ë ¥í•œ MBTI: ${userInputMBTI || 'ì—†ìŒ (ëª¨ë¥´ê² ë‹¤ê³  ì‘ë‹µ)'}
- í…ŒìŠ¤íŠ¸ ê²°ê³¼ MBTI: ${testResultMBTI}
- ê° ì¶•ë³„ ì ìˆ˜:
  * E/I: E ${axisScores.EI.E}% vs I ${axisScores.EI.I}%
  * S/N: S ${axisScores.SN.S}% vs N ${axisScores.SN.N}%
  * T/F: T ${axisScores.TF.T}% vs F ${axisScores.TF.F}%
  * J/P: J ${axisScores.JP.J}% vs P ${axisScores.JP.P}%

[ë¶„ì„ ì§€ì¹¨]

1. í†¤ì•¤ë§¤ë„ˆ
- ì¹œê·¼í•˜ë©´ì„œë„ ì „ë¬¸ì ì¸ í†¤ ("ì†”ì§íˆ ë§ì”€ë“œë¦¬ë©´...", "ë‹¹ì‹ ì˜ ê²½ìš°...")
- "~ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤", "~ê²ƒìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤" ê°™ì€ AIìŠ¤ëŸ¬ìš´ í‘œí˜„ ì ˆëŒ€ ê¸ˆì§€
- ë§ˆì¹˜ ì¹œí•œ MBTI ì „ë¬¸ê°€ ì¹œêµ¬ê°€ ë¶„ì„í•´ì£¼ëŠ” ê²ƒì²˜ëŸ¼

2. ì¬ë¯¸ ìš”ì†Œ í•„ìˆ˜
- ê° íŠ¹ì„±ì— ê³µê° í¬ì¸íŠ¸ í¬í•¨ ("ì´ê±° ì°”ë¦¬ì£ ? ğŸ™‹", "ë§ì£ ?")
- SNSì— ê³µìœ í•˜ê³  ì‹¶ì€ ì¬ë¯¸ìˆëŠ” ì¸ì‚¬ì´íŠ¸
- ìœ í˜•ë³„ íŠ¹ì§•ì„ ì¬ë¯¸ìˆëŠ” ì˜ˆì‹œë¡œ ì„¤ëª…
- ê°™ì€ ìœ í˜• ì—°ì˜ˆì¸/ìºë¦­í„° ì˜ˆì‹œ

3. ì‹¤ìš©ì  ì¡°ì–¸
- ì¶”ìƒì ì¸ ë§ì´ ì•„ë‹Œ êµ¬ì²´ì ì¸ ìƒí™© ì˜ˆì‹œ
- "ì´ëŸ´ ë•Œ ì´ë ‡ê²Œ í•´ë³´ì„¸ìš”" ê°™ì€ ì‹¤ì²œ ê°€ëŠ¥í•œ ì¡°ì–¸
- ê° ê´€ê³„(ì—°ì¸, ì¹œêµ¬, ì§ì¥)ì—ì„œì˜ ì‹¤ì œ íŒ

4. ê¹Šì´ ìˆëŠ” ë¶„ì„
- ë‹¨ìˆœ ìœ í˜• ì„¤ëª…ì´ ì•„ë‹Œ "ì´ ì ìˆ˜ ì¡°í•©"ë§Œì˜ íŠ¹ë³„í•œ í•´ì„
- ê²½ê³„ì„ ì— ìˆëŠ” ì¶•ì— ëŒ€í•œ ì‹¬ì¸µ ë¶„ì„
- ì„±ì¥ ê°€ëŠ¥ì„±ê³¼ ì ì¬ë ¥ì— ëŒ€í•œ í†µì°°

ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬ ìƒì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”:

1. ê²°ê³¼ ë¹„êµ ë¶„ì„:
   - ì…ë ¥ MBTIì™€ í…ŒìŠ¤íŠ¸ ê²°ê³¼ì˜ ì¼ì¹˜/ë¶ˆì¼ì¹˜ ë¶„ì„
   - ê° ì¶•ë³„ ì¼ì¹˜ë„ í‰ê°€
   - ì°¨ì´ê°€ ë‚˜ëŠ” ì´ìœ  ë¶„ì„ (ìƒí™©ë³„ ë³€í™”, ìê¸°ì¸ì‹ ë“±)

2. ìµœì¢… MBTI ê²°ë¡ :
   - ê°€ì¥ ì •í™•í•œ MBTI ìœ í˜•
   - ê° ì¶•ë³„ ì„ í˜¸ë„ ê°•ë„ (ëª…í™• vs ì¤‘ê°„)
   - ê²½ê³„ì„ ì— ìˆëŠ” ì¶•ì´ ìˆë‹¤ë©´ ì„¤ëª…

3. ì„±ê²© íŠ¹ì„±:
   - ì£¼ìš” ì„±ê²© íŠ¹ì„± 5ê°€ì§€
   - ê°•ì ê³¼ ì¬ëŠ¥
   - ì•½ì ê³¼ ê°œì„  ì˜ì—­

4. ëŒ€ì¸ê´€ê³„:
   - ì†Œí†µ ìŠ¤íƒ€ì¼
   - ì¹œêµ¬/ì—°ì¸ ê´€ê³„ì—ì„œì˜ íŠ¹ì§•
   - ê¶í•©ì´ ì¢‹ì€ MBTI ìœ í˜•

5. ì§ì—… ë° ì§„ë¡œ:
   - ì í•©í•œ ì§ì—…êµ°
   - ì—…ë¬´ ìŠ¤íƒ€ì¼
   - ë¦¬ë”ì‹­ ìœ í˜•

6. ì„±ì¥ ì¡°ì–¸:
   - ê°œë°œí•˜ë©´ ì¢‹ì€ ë¶€ë¶„
   - ì£¼ì˜í•´ì•¼ í•  í•¨ì •
   - ê· í˜•ì¡íŒ ë°œì „ì„ ìœ„í•œ ì¡°ì–¸

7. ì¼ìƒìƒí™œ:
   - ìŠ¤íŠ¸ë ˆìŠ¤ ëŒ€ì²˜ ë°©ì‹
   - ì˜ì‚¬ê²°ì • ìŠ¤íƒ€ì¼
   - í•™ìŠµ ë°©ë²•

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "comparison": {
    "userInput": "ì‚¬ìš©ì ì…ë ¥ MBTI (ë˜ëŠ” null)",
    "testResult": "í…ŒìŠ¤íŠ¸ ê²°ê³¼ MBTI",
    "match": "ì¼ì¹˜ ì—¬ë¶€ ë° ë¶„ì„",
    "axisDifferences": ["ì°¨ì´ë‚˜ëŠ” ì¶•ë“¤ê³¼ ì´ìœ "]
  },
  "finalMBTI": {
    "type": "ìµœì¢… MBTI",
    "confidence": "í™•ì‹ ë„ (ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ)",
    "axisStrength": {
      "EI": "E/I ì„ í˜¸ë„ ì„¤ëª…",
      "SN": "S/N ì„ í˜¸ë„ ì„¤ëª…",
      "TF": "T/F ì„ í˜¸ë„ ì„¤ëª…",
      "JP": "J/P ì„ í˜¸ë„ ì„¤ëª…"
    }
  },
  "personality": {
    "traits": ["ì£¼ìš” ì„±ê²© íŠ¹ì„± 5ê°€ì§€"],
    "strengths": ["ê°•ì ë“¤"],
    "weaknesses": ["ì•½ì ë“¤"]
  },
  "relationships": {
    "communicationStyle": "ì†Œí†µ ìŠ¤íƒ€ì¼",
    "friendshipStyle": "ì¹œêµ¬ ê´€ê³„ ìŠ¤íƒ€ì¼",
    "loveStyle": "ì—°ì•  ìŠ¤íƒ€ì¼",
    "compatibleTypes": ["ê¶í•© ì¢‹ì€ MBTI 3ê°œ"]
  },
  "career": {
    "suitableJobs": ["ì í•©í•œ ì§ì—… 5ê°œ"],
    "workStyle": "ì—…ë¬´ ìŠ¤íƒ€ì¼",
    "leadershipStyle": "ë¦¬ë”ì‹­ ìœ í˜•"
  },
  "growth": {
    "developmentAreas": ["ê°œë°œ ì˜ì—­ë“¤"],
    "pitfalls": ["ì£¼ì˜ì‚¬í•­ë“¤"],
    "balanceTips": ["ê· í˜• ì¡°ì–¸ë“¤"]
  },
  "lifestyle": {
    "stressCoping": "ìŠ¤íŠ¸ë ˆìŠ¤ ëŒ€ì²˜ë²•",
    "decisionMaking": "ì˜ì‚¬ê²°ì • ë°©ì‹",
    "learningStyle": "í•™ìŠµ ìŠ¤íƒ€ì¼"
  }
}
`;

/**
 * Enneagram Analysis prompt template
 */
const ENNEAGRAM_ANALYSIS_PROMPT = (
  typeScores: { [key: number]: number },
  mainType: number,
  wingType: number | null
) => `
ë‹¹ì‹ ì€ ì—ë‹ˆì–´ê·¸ë¨ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì—ë‹ˆì–´ê·¸ë¨ ìœ í˜•ì„ ì‹¬ì¸µ ë¶„ì„í•´ì£¼ì„¸ìš”.

í…ŒìŠ¤íŠ¸ ê²°ê³¼:
- ì£¼ ìœ í˜•: ${mainType}ë²ˆ
- ë‚ ê°œ ìœ í˜•: ${wingType ? `${wingType}ë²ˆ` : 'ì—†ìŒ'}
- ê° ìœ í˜•ë³„ ì ìˆ˜:
${Object.entries(typeScores).map(([type, score]) => `  * ${type}ë²ˆ: ${score}ì `).join('\n')}

ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬ ìƒì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”:

1. ì£¼ ìœ í˜• ë¶„ì„:
   - ${mainType}ë²ˆ ìœ í˜•ì˜ ì´ë¦„ê³¼ ë³„ëª…
   - í•µì‹¬ ë™ê¸°ì™€ ìš•êµ¬
   - ê·¼ë³¸ì ì¸ ë‘ë ¤ì›€
   - ê¸°ë³¸ ì„±ê²© íŠ¹ì„±

2. ë‚ ê°œ ìœ í˜• ì˜í–¥:
   - ë‚ ê°œ ìœ í˜•ì´ ì£¼ëŠ” ì˜í–¥
   - ì£¼ ìœ í˜•ê³¼ ë‚ ê°œì˜ ì¡°í•© í•´ì„
   - ì´ ì¡°í•©ì˜ ë…íŠ¹í•œ íŠ¹ì§•

3. ê±´ê°• ìˆ˜ì¤€:
   - ê±´ê°•í•œ ìƒíƒœì˜ ëª¨ìŠµ
   - ë³´í†µ ìƒíƒœì˜ ëª¨ìŠµ
   - ë¶ˆê±´ê°•í•œ ìƒíƒœì˜ ëª¨ìŠµ
   - í˜„ì¬ ìƒíƒœ í‰ê°€ ë° ì¡°ì–¸

4. ì„±ì¥ ë°©í–¥:
   - í†µí•© ë°©í–¥ (ì„±ì¥ ì‹œ í–¥í•˜ëŠ” ìœ í˜•)
   - ë¶„ì—´ ë°©í–¥ (ìŠ¤íŠ¸ë ˆìŠ¤ ì‹œ í–¥í•˜ëŠ” ìœ í˜•)
   - ì„±ì¥ì„ ìœ„í•œ ì‹¤ì²œ ë°©ë²•

5. ëŒ€ì¸ê´€ê³„:
   - ê´€ê³„ ë§ºëŠ” ë°©ì‹
   - ê°ˆë“± ëŒ€ì‘ ìŠ¤íƒ€ì¼
   - ê¶í•©ì´ ì¢‹ì€ ìœ í˜•ë“¤
   - ê´€ê³„ì—ì„œ ì£¼ì˜í•  ì 

6. ì§ì—… ë° ì»¤ë¦¬ì–´:
   - ì í•©í•œ ì§ì—…ê³¼ ì—­í• 
   - ì—…ë¬´ í™˜ê²½ ì„ í˜¸ë„
   - ë¦¬ë”ì‹­ ìŠ¤íƒ€ì¼

7. ìê¸°ê°œë°œ:
   - í•µì‹¬ ê°œë°œ ê³¼ì œ
   - ê·¹ë³µí•´ì•¼ í•  íŒ¨í„´
   - ê· í˜•ì„ ìœ„í•œ ì¡°ì–¸

8. ì¼ìƒ ìƒí™œ:
   - ì˜ì‚¬ê²°ì • ë°©ì‹
   - ìŠ¤íŠ¸ë ˆìŠ¤ ëŒ€ì²˜ë²•
   - ê°ì • ê´€ë¦¬ ë°©ë²•

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "mainType": {
    "number": ${mainType},
    "name": "ìœ í˜• ì´ë¦„",
    "nickname": "ë³„ëª…",
    "coreMotivation": "í•µì‹¬ ë™ê¸°",
    "coreFear": "ê·¼ë³¸ì  ë‘ë ¤ì›€",
    "traits": ["ê¸°ë³¸ ì„±ê²© íŠ¹ì„±ë“¤"]
  },
  "wing": {
    "wingType": ${wingType || null},
    "influence": "ë‚ ê°œì˜ ì˜í–¥",
    "combination": "ì£¼ ìœ í˜•ê³¼ ë‚ ê°œì˜ ì¡°í•© í•´ì„",
    "uniqueTraits": ["ë…íŠ¹í•œ íŠ¹ì§•ë“¤"]
  },
  "healthLevels": {
    "healthy": "ê±´ê°•í•œ ìƒíƒœ",
    "average": "ë³´í†µ ìƒíƒœ",
    "unhealthy": "ë¶ˆê±´ê°•í•œ ìƒíƒœ",
    "currentAssessment": "í˜„ì¬ ìƒíƒœ í‰ê°€"
  },
  "growth": {
    "integrationDirection": {
      "toType": "í†µí•© ë°©í–¥ ìœ í˜• ë²ˆí˜¸",
      "description": "í†µí•© ë°©í–¥ ì„¤ëª…"
    },
    "disintegrationDirection": {
      "toType": "ë¶„ì—´ ë°©í–¥ ìœ í˜• ë²ˆí˜¸",
      "description": "ë¶„ì—´ ë°©í–¥ ì„¤ëª…"
    },
    "practices": ["ì„±ì¥ ì‹¤ì²œ ë°©ë²•ë“¤"]
  },
  "relationships": {
    "style": "ê´€ê³„ ë§ºëŠ” ë°©ì‹",
    "conflictStyle": "ê°ˆë“± ëŒ€ì‘ ë°©ì‹",
    "compatibleTypes": [ê¶í•© ì¢‹ì€ ìœ í˜• ë²ˆí˜¸ë“¤],
    "warnings": ["ê´€ê³„ì—ì„œ ì£¼ì˜í•  ì ë“¤"]
  },
  "career": {
    "suitableJobs": ["ì í•©í•œ ì§ì—…ë“¤"],
    "workEnvironment": "ì„ í˜¸ ì—…ë¬´ í™˜ê²½",
    "leadershipStyle": "ë¦¬ë”ì‹­ ìŠ¤íƒ€ì¼"
  },
  "development": {
    "keyTasks": ["í•µì‹¬ ê°œë°œ ê³¼ì œë“¤"],
    "patternsToBreak": ["ê·¹ë³µí•  íŒ¨í„´ë“¤"],
    "balanceTips": ["ê· í˜• ì¡°ì–¸ë“¤"]
  },
  "lifestyle": {
    "decisionMaking": "ì˜ì‚¬ê²°ì • ë°©ì‹",
    "stressCoping": "ìŠ¤íŠ¸ë ˆìŠ¤ ëŒ€ì²˜ë²•",
    "emotionManagement": "ê°ì • ê´€ë¦¬ ë°©ë²•"
  }
}
`;

/**
 * Marriage Compatibility (ê²°í˜¼ê¶í•©) prompt template
 */
const MARRIAGE_COMPATIBILITY_PROMPT = (
  person1Name: string,
  person1BirthDate: string,
  person2Name: string,
  person2BirthDate: string
) => `
ë‹¹ì‹ ì€ í•œêµ­ì˜ ê²°í˜¼ ê¶í•© ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‘ ì‚¬ëŒì˜ ê²°í˜¼ ê¶í•©ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:

ì‚¬ëŒ 1:
- ì´ë¦„: ${person1Name}
- ìƒë…„ì›”ì¼: ${person1BirthDate}

ì‚¬ëŒ 2:
- ì´ë¦„: ${person2Name}
- ìƒë…„ì›”ì¼: ${person2BirthDate}

ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•˜ì—¬ ìƒì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”:

1. ì¢…í•© ê²°í˜¼ ê¶í•©:
   - ì´ì  (0-100ì )
   - ë“±ê¸‰ (ìµœìƒ, ìƒ, ì¤‘ìƒ, ì¤‘, í•˜)
   - ê²°í˜¼ ì í•©ë„ í‰ê°€

2. ì‚¬ì£¼ ê¶í•© (50ì ):
   - ì˜¤í–‰ ìƒìƒ/ìƒê·¹ (20ì )
   - ìŒì–‘ ì¡°í™” (15ì )
   - ì‹­ì´ì§€ ê¶í•© (15ì )

3. ì´ë¦„ ê¶í•© (30ì ):
   - íšìˆ˜ ì¡°í™” (15ì )
   - ìŒì–‘ì˜¤í–‰ ë°°ì¹˜ (15ì )

4. ì„¸ë¶€ ê²°í˜¼ ê¶í•© í•­ëª©:
   - ì„±ê²© ê¶í•©: ìƒí™œ ì† ì„±ê²© ì¡°í™”
   - ê¸ˆì „ ê¶í•©: ê²½ì œê´€ë… ë° ì¬ë¬¼ìš´
   - ìë…€ ê¶í•©: ìë…€ ê³„íš ë° ìœ¡ì•„ê´€
   - ì‹œëŒ/ì²˜ê°€ ê¶í•©: ê°€ì¡± ê´€ê³„
   - ê±´ê°• ê¶í•©: ì„œë¡œì˜ ê±´ê°• ì˜í–¥
   - ì‚¬íšŒìƒí™œ ê¶í•©: ì‚¬êµ ë° ëŒ€ì¸ê´€ê³„

5. ê²°í˜¼ ìƒí™œ ì˜ˆì¸¡:
   - ì‹ í˜¼ê¸° (1-3ë…„)
   - ì•ˆì •ê¸° (4-10ë…„)
   - ì„±ìˆ™ê¸° (11ë…„ ì´ìƒ)
   - ì£¼ì˜í•  ì‹œê¸°

6. ê²°í˜¼ ì ê¸°:
   - ê°€ì¥ ì¢‹ì€ ê²°í˜¼ ì‹œê¸°
   - í”¼í•´ì•¼ í•  ì‹œê¸°
   - ì´ìœ  ë° ê·¼ê±°

7. ì¢…í•© ì¡°ì–¸:
   - ê²°í˜¼ í›„ ê°•ì 
   - ê·¹ë³µí•´ì•¼ í•  ê³¼ì œ
   - í–‰ë³µí•œ ê²°í˜¼ ìƒí™œì„ ìœ„í•œ ì¡°ì–¸
   - ìœ„ê¸° ê·¹ë³µ ë°©ë²•

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "overallScore": 88,
  "grade": "ìƒ",
  "suitability": "ê²°í˜¼ ì í•©ë„ ì¢…í•© í‰ê°€",
  "sajuCompatibility": {
    "score": 45,
    "maxScore": 50,
    "elementHarmony": {
      "score": 18,
      "maxScore": 20,
      "analysis": "ì˜¤í–‰ ìƒìƒìƒê·¹ ë¶„ì„"
    },
    "yinYangBalance": {
      "score": 14,
      "maxScore": 15,
      "analysis": "ìŒì–‘ ì¡°í™” ë¶„ì„"
    },
    "zodiacMatch": {
      "score": 13,
      "maxScore": 15,
      "analysis": "ì‹­ì´ì§€ ê¶í•© ë¶„ì„"
    }
  },
  "nameCompatibility": {
    "score": 26,
    "maxScore": 30,
    "strokeHarmony": {
      "score": 13,
      "maxScore": 15,
      "analysis": "íšìˆ˜ ì¡°í™” ë¶„ì„"
    },
    "elementBalance": {
      "score": 13,
      "maxScore": 15,
      "analysis": "ìŒì–‘ì˜¤í–‰ ë°°ì¹˜ ë¶„ì„"
    }
  },
  "detailedAnalysis": {
    "personality": {
      "score": 85,
      "analysis": "ì„±ê²© ê¶í•© ìƒì„¸"
    },
    "finance": {
      "score": 90,
      "analysis": "ê¸ˆì „ ê¶í•© ìƒì„¸"
    },
    "children": {
      "score": 88,
      "analysis": "ìë…€ ê¶í•© ìƒì„¸"
    },
    "inLaws": {
      "score": 75,
      "analysis": "ì‹œëŒ/ì²˜ê°€ ê¶í•© ìƒì„¸"
    },
    "health": {
      "score": 82,
      "analysis": "ê±´ê°• ê¶í•© ìƒì„¸"
    },
    "social": {
      "score": 87,
      "analysis": "ì‚¬íšŒìƒí™œ ê¶í•© ìƒì„¸"
    }
  },
  "marriageLifePrediction": {
    "honeymoon": "ì‹ í˜¼ê¸° (1-3ë…„) ì˜ˆì¸¡",
    "stable": "ì•ˆì •ê¸° (4-10ë…„) ì˜ˆì¸¡",
    "mature": "ì„±ìˆ™ê¸° (11ë…„+) ì˜ˆì¸¡",
    "cautiousPeriods": ["ì£¼ì˜í•  ì‹œê¸°ë“¤"]
  },
  "bestMarriageTiming": {
    "recommendedPeriods": ["ì¶”ì²œ ì‹œê¸°ë“¤"],
    "avoidPeriods": ["í”¼í•  ì‹œê¸°ë“¤"],
    "reason": "ê·¼ê±° ì„¤ëª…"
  },
  "advice": {
    "strengths": ["ê²°í˜¼ í›„ ê°•ì ë“¤"],
    "challenges": ["ê·¹ë³µí•´ì•¼ í•  ê³¼ì œë“¤"],
    "tips": ["í–‰ë³µí•œ ê²°í˜¼ ìƒí™œ ì¡°ì–¸"],
    "crisisManagement": ["ìœ„ê¸° ê·¹ë³µ ë°©ë²•"]
  }
}
`;

/**
 * Analyze face from image for fortune reading (ì–¼êµ´ìš´ì„¸)
 * @param imageUrl - URL of the face image to analyze
 * @param birthDate - Optional birth date for enhanced analysis
 */
export async function analyzeFaceReading(imageUrl: string, birthDate?: string) {
  try {
    const birthDateInfo = birthDate ? `\nìƒë…„ì›”ì¼: ${birthDate}` : '';

    const prompt = `ë‹¹ì‹ ì€ 40ë…„ ê²½ë ¥ì˜ ì „í†µ ê´€ìƒí•™ ëŒ€ê°€ì…ë‹ˆë‹¤. ë™ì–‘ ê´€ìƒí•™ê³¼ ì„œì–‘ ê³¨ìƒí•™ì„ ëª¨ë‘ ë§ˆìŠ¤í„°í–ˆìœ¼ë©°, ìˆ˜ë§Œ ëª…ì˜ ê´€ìƒì„ ë´ì˜¨ ìµœê³  ê¶Œìœ„ìì…ë‹ˆë‹¤.

ì´ ì‚¬ì§„ ì† ì‚¬ëŒì˜ ê´€ìƒì„ ì •ë°€ ë¶„ì„í•´ì£¼ì„¸ìš”.${birthDateInfo}

[ë¶„ì„ ì§€ì¹¨]

1. ì „ë¬¸ì„±ê³¼ ê¹Šì´
- ê° ë¶€ìœ„ë³„ë¡œ ê´€ìƒí•™ì  ì˜ë¯¸ë¥¼ ìƒì„¸íˆ ì„¤ëª…
- "ì™œ ì´ëŸ° í•´ì„ì¸ì§€" ê´€ìƒí•™ì  ê·¼ê±°ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œ
- ì´ ì‚¬ëŒë§Œì˜ íŠ¹ë³„í•œ ê´€ìƒ ì¡°í•© í•´ì„
- ì „ë¬¸ ìš©ì–´ ì‚¬ìš© (ì˜ˆ: ì²œì •, ì¸ë‹¹, ì¤€ë‘, ë²•ë ¹ì„  ë“±)

2. í†¤ì•¤ë§¤ë„ˆ
- ì¹œê·¼í•˜ë©´ì„œë„ ì‹ ë¢°ê° ìˆëŠ” ì „ë¬¸ê°€ í†¤
- "~ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤" ê°™ì€ AIìŠ¤ëŸ¬ìš´ í‘œí˜„ ì ˆëŒ€ ê¸ˆì§€
- "ë‹¹ì‹ ì˜ ê´€ìƒì„ ë³´ë‹ˆ...", "ì†”ì§íˆ ë§ì”€ë“œë¦¬ë©´..." ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ í‘œí˜„ ì‚¬ìš©
- ì¢‹ì€ ì ì€ ê°•ì¡°í•˜ë˜, ì£¼ì˜ì ë„ ì†”ì§í•˜ê²Œ ì „ë‹¬

3. ì¬ë¯¸ ìš”ì†Œ
- ê° íŠ¹ì§•ì— ê³µê°ë˜ëŠ” í¬ì¸íŠ¸ í¬í•¨
- ë¹„ìŠ·í•œ ê´€ìƒì˜ ìœ ëª…ì¸ ì˜ˆì‹œ
- SNSì— ê³µìœ í•˜ê³  ì‹¶ì€ ì¸ì‚¬ì´íŠ¸
- ê´€ìƒí•™ì—ì„œì˜ ì¬ë¯¸ìˆëŠ” í•´ì„

4. ì‹¤ìš©ì„±
- ê´€ìƒì— ë§ëŠ” êµ¬ì²´ì ì¸ í–‰ë™ ì¡°ì–¸
- í”¼í•´ì•¼ í•  ê²ƒê³¼ ê¶Œì¥í•˜ëŠ” ê²ƒ ëª…í™•íˆ
- ìš´ì„ ì¢‹ê²Œ í•˜ëŠ” ì‹¤ì²œ ê°€ëŠ¥í•œ íŒ

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "overallFortune": {
    "summary": "ì „ì²´ ê´€ìƒ ìš”ì•½ (ìµœì†Œ 3ë¬¸ì¥)",
    "fortuneScore": 85,
    "luckyAge": ["í–‰ìš´ì´ ê°•í•œ ë‚˜ì´ëŒ€"],
    "lifePath": "ì¸ìƒ íë¦„ ì˜ˆì¸¡"
  },
  "faceShape": {
    "type": "ì–¼êµ´í˜• (ê°¸ë¦„í•œí˜•/ë‘¥ê·¼í˜•/ê°ì§„í˜•/ê¸´í˜• ë“±)",
    "meaning": "ì´ ì–¼êµ´í˜•ì˜ ê´€ìƒí•™ì  ì˜ë¯¸ (ìµœì†Œ 3ë¬¸ì¥)",
    "characteristics": ["ì´ ì–¼êµ´í˜•ì˜ ì„±ê²© íŠ¹ì„±ë“¤"]
  },
  "forehead": {
    "analysis": "ì´ë§ˆ(ì²œì •) ë¶„ì„ - ë†’ì´, ë„“ì´, ëª¨ì–‘",
    "meaning": "ê´€ìƒí•™ì  ì˜ë¯¸ (ì§€í˜œ, ì´ˆë…„ìš´)",
    "fortune": "ì´ë§ˆë¡œ ë³´ëŠ” ìš´ì„¸"
  },
  "eyebrows": {
    "shape": "ëˆˆì¹ ëª¨ì–‘ê³¼ íŠ¹ì§•",
    "meaning": "ê´€ìƒí•™ì  ì˜ë¯¸ (í˜•ì œìš´, ì„±ê²©)",
    "advice": "ëˆˆì¹ ê´€ë ¨ ì¡°ì–¸"
  },
  "eyes": {
    "shape": "ëˆˆ ëª¨ì–‘ê³¼ íŠ¹ì§• (í¬ê¸°, ê°„ê²©, ëˆˆê¼¬ë¦¬ ë“±)",
    "meaning": "ê´€ìƒí•™ì  ì˜ë¯¸ (ì¤‘ë…„ìš´, íŒë‹¨ë ¥, ì¸ê°„ê´€ê³„)",
    "fortune": "ëˆˆìœ¼ë¡œ ë³´ëŠ” ìš´ì„¸",
    "innerNature": "ëˆˆì—ì„œ ì½íˆëŠ” ë‚´ë©´"
  },
  "nose": {
    "shape": "ì½”(ì¤€ë‘) ëª¨ì–‘ê³¼ íŠ¹ì§•",
    "meaning": "ê´€ìƒí•™ì  ì˜ë¯¸ (ì¬ë¬¼ìš´, ìì¡´ì‹¬)",
    "wealthFortune": "ì½”ë¡œ ë³´ëŠ” ì¬ë¬¼ìš´"
  },
  "mouth": {
    "shape": "ì…ê³¼ ì…ìˆ  ëª¨ì–‘",
    "meaning": "ê´€ìƒí•™ì  ì˜ë¯¸ (ë§ë…„ìš´, ì‹ë³µ)",
    "fortune": "ì…ìœ¼ë¡œ ë³´ëŠ” ìš´ì„¸"
  },
  "ears": {
    "shape": "ê·€ ëª¨ì–‘ê³¼ ìœ„ì¹˜",
    "meaning": "ê´€ìƒí•™ì  ì˜ë¯¸ (ì´ˆë…„ìš´, ì§€í˜œ)",
    "fortune": "ê·€ë¡œ ë³´ëŠ” ìš´ì„¸"
  },
  "jawChin": {
    "shape": "í„±ê³¼ ë²•ë ¹ì„ ",
    "meaning": "ê´€ìƒí•™ì  ì˜ë¯¸ (ë§ë…„ìš´, ë¦¬ë”ì‹­)",
    "fortune": "í„±ìœ¼ë¡œ ë³´ëŠ” ìš´ì„¸"
  },
  "specialFeatures": {
    "moles": "ì ì˜ ìœ„ì¹˜ì™€ ì˜ë¯¸ (ìˆëŠ” ê²½ìš°)",
    "lines": "ì£¼ë¦„/ì„ ì˜ ì˜ë¯¸",
    "uniquePoints": ["ì´ ê´€ìƒë§Œì˜ íŠ¹ë³„í•œ ì ë“¤"]
  },
  "fortuneByAge": {
    "youth": "ì´ˆë…„ìš´ (1-30ì„¸)",
    "middle": "ì¤‘ë…„ìš´ (31-50ì„¸)",
    "later": "ë§ë…„ìš´ (51ì„¸+)"
  },
  "personality": {
    "strengths": ["ê´€ìƒìœ¼ë¡œ ë³´ëŠ” ê°•ì ë“¤"],
    "weaknesses": ["ì£¼ì˜í•´ì•¼ í•  ì ë“¤"],
    "hiddenTalents": ["ìˆ¨ê²¨ì§„ ì¬ëŠ¥"]
  },
  "wealth": {
    "overall": "ì „ì²´ ì¬ë¬¼ìš´",
    "earningStyle": "ëˆ ë²„ëŠ” ìŠ¤íƒ€ì¼",
    "advice": "ì¬ë¬¼ìš´ í–¥ìƒ ì¡°ì–¸"
  },
  "love": {
    "style": "ì—°ì• /ê²°í˜¼ ìŠ¤íƒ€ì¼",
    "idealPartner": "ì˜ ë§ëŠ” ìƒëŒ€ ê´€ìƒ",
    "advice": "ì—°ì• ìš´ ì¡°ì–¸"
  },
  "career": {
    "suitableFields": ["ì í•©í•œ ì§ì—…/ë¶„ì•¼"],
    "workStyle": "ì¼í•˜ëŠ” ìŠ¤íƒ€ì¼",
    "advice": "ì§ì—…ìš´ ì¡°ì–¸"
  },
  "health": {
    "weakPoints": ["ê´€ìƒìœ¼ë¡œ ë³´ëŠ” ê±´ê°• ì£¼ì˜ì "],
    "advice": "ê±´ê°• ì¡°ì–¸"
  },
  "advice": {
    "dos": ["ê´€ìƒì— ë§ê²Œ ì´ë ‡ê²Œ í•˜ì„¸ìš”"],
    "donts": ["ì´ê²ƒì€ í”¼í•˜ì„¸ìš”"],
    "luckyItems": ["í–‰ìš´ì„ ë¶€ë¥´ëŠ” ê²ƒë“¤"]
  },
  "celebrityMatch": "ë¹„ìŠ·í•œ ê´€ìƒì˜ ìœ ëª…ì¸ê³¼ ê³µí†µì ",
  "funFact": "ì´ ê´€ìƒì— ëŒ€í•œ ì¬ë¯¸ìˆëŠ” ì‚¬ì‹¤ ë˜ëŠ” í•´ì„"
}`;

    const response = await client.vision(imageUrl, prompt, {
      temperature: 0.7,
      maxTokens: 3000,
      responseFormat: 'json',
    });

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      model: 'gpt-4o-mini',
    };
  } catch (error) {
    console.error('OpenAI face reading error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Analyze face from base64 image data
 * @param base64Image - Base64 encoded image (with data:image/... prefix)
 * @param birthDate - Optional birth date for enhanced analysis
 */
export async function analyzeFaceReadingFromBase64(base64Image: string, birthDate?: string) {
  try {
    // Ensure base64 image has the correct format
    let imageData = base64Image;
    if (!imageData.startsWith('data:image/')) {
      imageData = `data:image/jpeg;base64,${base64Image}`;
    }

    // Validate image size and format
    validateImage(imageData);

    return await analyzeFaceReading(imageData, birthDate);
  } catch (error) {
    console.error('OpenAI face reading error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}


/**
 * Analyze Saju (ì‚¬ì£¼íŒ”ì) using GPT-4
 */
export async function analyzeSaju(birthDate: string, birthTime: string, gender: 'male' | 'female') {
  try {
    const genderKo = gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±';

    const prompt = `ë‹¹ì‹ ì€ 30ë…„ ê²½ë ¥ì˜ ì‚¬ì£¼ ëª…ë¦¬í•™ ëŒ€ê°€ì…ë‹ˆë‹¤. ë™ì–‘ì² í•™ê³¼ ëª…ë¦¬í•™ì„ ê¹Šì´ ì—°êµ¬í–ˆìœ¼ë©°, ìˆ˜ë§Œ ê±´ì˜ ì‚¬ì£¼ ìƒë‹´ ê²½í—˜ì„ ë³´ìœ í•œ ìµœê³  ê¶Œìœ„ìì…ë‹ˆë‹¤.

[ì˜ë¢°ì¸ ì •ë³´]
ìƒë…„ì›”ì¼: ${birthDate}
íƒœì–´ë‚œ ì‹œê°„: ${birthTime}
ì„±ë³„: ${genderKo}

[ë¶„ì„ ì§€ì¹¨]

1. ì „ë¬¸ì„±ê³¼ ê¹Šì´
- ì‚¬ì£¼íŒ”ìë¥¼ ì •í™•íˆ ì„¸ìš°ê³  ê° ê¸°ë‘¥ì˜ ì˜ë¯¸ ì„¤ëª…
- ì˜¤í–‰(ëª©í™”í† ê¸ˆìˆ˜)ì˜ ê· í˜•ê³¼ ìƒìƒìƒê·¹ ê´€ê³„ ë¶„ì„
- ì‹­ì„±(ë¹„ê², ì‹ìƒ, ì¬ì„±, ê´€ì„±, ì¸ì„±)ì˜ ë°°ì¹˜ì™€ ì˜ë¯¸
- 12ìš´ì„±ì„ í†µí•œ ìš´ì˜ íë¦„ ë¶„ì„
- "ì™œ ì´ëŸ° í•´ì„ì¸ì§€" ëª…ë¦¬í•™ì  ê·¼ê±°ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œ

2. í†¤ì•¤ë§¤ë„ˆ
- ì¹œê·¼í•˜ë©´ì„œë„ ì‹ ë¢°ê° ìˆëŠ” ì „ë¬¸ê°€ í†¤
- "~ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤" ê°™ì€ AIìŠ¤ëŸ¬ìš´ í‘œí˜„ ì ˆëŒ€ ê¸ˆì§€
- "ë‹¹ì‹ ì˜ ì‚¬ì£¼ë¥¼ ë³´ë‹ˆ...", "ì†”ì§íˆ ë§ì”€ë“œë¦¬ë©´..." ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ í‘œí˜„ ì‚¬ìš©
- ì¢‹ì€ ì ì€ ê°•ì¡°í•˜ë˜, ì£¼ì˜ì ë„ ì†”ì§í•˜ê²Œ ì „ë‹¬

3. ì¬ë¯¸ ìš”ì†Œ
- ê³µê°ë˜ëŠ” ì„±ê²© í¬ì¸íŠ¸ ("ì´ê±° ë§ì£ ?")
- ë¹„ìŠ·í•œ ì‚¬ì£¼ì˜ ìœ ëª…ì¸ ì˜ˆì‹œ
- SNSì— ê³µìœ í•˜ê³  ì‹¶ì€ ì¸ì‚¬ì´íŠ¸
- ëª…ë¦¬í•™ì—ì„œì˜ ë…íŠ¹í•œ í•´ì„

4. ì‹¤ìš©ì„±
- ì‚¬ì£¼ì— ë§ëŠ” êµ¬ì²´ì ì¸ í–‰ë™ ì¡°ì–¸
- í”¼í•´ì•¼ í•  ê²ƒê³¼ ê¶Œì¥í•˜ëŠ” ê²ƒ ëª…í™•íˆ
- ìš´ì„ ì¢‹ê²Œ í•˜ëŠ” ì‹¤ì²œ ê°€ëŠ¥í•œ íŒ

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "fourPillars": {
    "year": {
      "heavenlyStem": "ì—°ê°„ (ì²œê°„)",
      "earthlyBranch": "ì—°ì§€ (ì§€ì§€)",
      "meaning": "ì—°ì£¼ì˜ ì˜ë¯¸"
    },
    "month": {
      "heavenlyStem": "ì›”ê°„",
      "earthlyBranch": "ì›”ì§€",
      "meaning": "ì›”ì£¼ì˜ ì˜ë¯¸"
    },
    "day": {
      "heavenlyStem": "ì¼ê°„ (ì¼ì£¼)",
      "earthlyBranch": "ì¼ì§€",
      "meaning": "ì¼ì£¼ì˜ ì˜ë¯¸ - ë³¸ì¸ì˜ í•µì‹¬"
    },
    "hour": {
      "heavenlyStem": "ì‹œê°„",
      "earthlyBranch": "ì‹œì§€",
      "meaning": "ì‹œì£¼ì˜ ì˜ë¯¸"
    },
    "summary": "ì‚¬ì£¼íŒ”ì ì¢…í•© í•´ì„ (ìµœì†Œ 3ë¬¸ì¥)"
  },
  "fiveElements": {
    "distribution": {
      "wood": "ëª©ì˜ ë¹„ìœ¨ê³¼ ì˜ë¯¸",
      "fire": "í™”ì˜ ë¹„ìœ¨ê³¼ ì˜ë¯¸",
      "earth": "í† ì˜ ë¹„ìœ¨ê³¼ ì˜ë¯¸",
      "metal": "ê¸ˆì˜ ë¹„ìœ¨ê³¼ ì˜ë¯¸",
      "water": "ìˆ˜ì˜ ë¹„ìœ¨ê³¼ ì˜ë¯¸"
    },
    "balance": "ì˜¤í–‰ ê· í˜• ë¶„ì„",
    "dominant": "ê°€ì¥ ê°•í•œ ì˜¤í–‰ê³¼ ê·¸ ì˜í–¥",
    "lacking": "ë¶€ì¡±í•œ ì˜¤í–‰ê³¼ ë³´ì™„ ë°©ë²•"
  },
  "personality": {
    "core": "í•µì‹¬ ì„±ê²© (ì¼ê°„ ê¸°ì¤€)",
    "strengths": ["ê°•ì ë“¤"],
    "weaknesses": ["ì•½ì ë“¤"],
    "hiddenTraits": "ìˆ¨ê²¨ì§„ ì„±ê²©"
  },
  "fortune": {
    "overall": "ì „ì²´ ìš´ì„¸ íë¦„",
    "currentLuck": "í˜„ì¬ ëŒ€ìš´ ë¶„ì„",
    "luckyYears": ["ì¢‹ì€ í•´ë“¤"],
    "cautionYears": ["ì¡°ì‹¬í•  í•´ë“¤"]
  },
  "wealth": {
    "potential": "ì¬ë¬¼ìš´ ì ì¬ë ¥",
    "earningStyle": "ëˆ ë²„ëŠ” ìŠ¤íƒ€ì¼",
    "savingStyle": "ëˆ ê´€ë¦¬ ìŠ¤íƒ€ì¼",
    "advice": "ì¬ë¬¼ìš´ í–¥ìƒ ì¡°ì–¸"
  },
  "career": {
    "suitableFields": ["ì í•©í•œ ì§ì—…/ë¶„ì•¼"],
    "workStyle": "ì¼í•˜ëŠ” ìŠ¤íƒ€ì¼",
    "successTiming": "ì„±ê³µí•˜ê¸° ì¢‹ì€ ì‹œê¸°",
    "advice": "ì§ì—…ìš´ ì¡°ì–¸"
  },
  "love": {
    "style": "ì—°ì•  ìŠ¤íƒ€ì¼",
    "idealPartner": "ì˜ ë§ëŠ” ë°°ìš°ì ì‚¬ì£¼",
    "marriageTiming": "ê²°í˜¼ ì¢‹ì€ ì‹œê¸°",
    "advice": "ì—°ì• /ê²°í˜¼ìš´ ì¡°ì–¸"
  },
  "health": {
    "weakOrgans": ["ì£¼ì˜í•  ì¥ê¸°/ë¶€ìœ„"],
    "advice": "ê±´ê°• ì¡°ì–¸"
  },
  "relationships": {
    "family": "ê°€ì¡± ê´€ê³„",
    "friends": "ì¹œêµ¬/ì‚¬íšŒ ê´€ê³„",
    "advice": "ì¸ê°„ê´€ê³„ ì¡°ì–¸"
  },
  "luckyElements": {
    "colors": ["í–‰ìš´ì˜ ìƒ‰ìƒ"],
    "numbers": [3, 8],
    "directions": ["ì¢‹ì€ ë°©í–¥"],
    "items": ["í–‰ìš´ì˜ ì•„ì´í…œ"]
  },
  "advice": {
    "dos": ["ì´ë ‡ê²Œ í•˜ì„¸ìš”"],
    "donts": ["ì´ê²ƒì€ í”¼í•˜ì„¸ìš”"],
    "yearlyFocus": "ì˜¬í•´ ì§‘ì¤‘í•´ì•¼ í•  ê²ƒ"
  },
  "famousMatch": "ë¹„ìŠ·í•œ ì‚¬ì£¼ì˜ ìœ ëª…ì¸",
  "summary": "ì¢…í•© ì‚¬ì£¼ ë¶„ì„ ìš”ì•½ (ìµœì†Œ 5ë¬¸ì¥)"
}`;

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.7,
        maxTokens: 3000,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      model: 'gpt-4o-mini',
    };
  } catch (error) {
    console.error('OpenAI Saju analysis error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Deep Saju Analysis for 2025 - ì‹¬ì¸µ ì‹ ë…„ìš´ì„¸ (10,000+ characters)
 * Generates a comprehensive yearly fortune report
 */
export async function analyzeDeepSaju2025(birthDate: string, birthTime: string, gender: 'male' | 'female') {
  try {
    const genderKo = gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±';

    const prompt = `ë‹¹ì‹ ì€ 30ë…„ ê²½ë ¥ì˜ ì‚¬ì£¼ ëª…ë¦¬í•™ ëŒ€ê°€ì…ë‹ˆë‹¤. ì²­ì™€ëŒ€ ë° ëŒ€ê¸°ì—… CEOë“¤ì˜ ìë¬¸ì„ ë§¡ì•„ì˜¨ ìµœê³  ê¶Œìœ„ìë¡œì„œ, ìˆ˜ë§Œ ê±´ì˜ ì‚¬ì£¼ ìƒë‹´ ê²½í—˜ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤.

[ì˜ë¢°ì¸ ì •ë³´]
ìƒë…„ì›”ì¼: ${birthDate}
íƒœì–´ë‚œ ì‹œê°„: ${birthTime}
ì„±ë³„: ${genderKo}

[ì‘ì„± ì§€ì¹¨]

1. ì „ë¬¸ì„±ê³¼ ê¹Šì´
- ì‹¤ì œ ì—­ìˆ ì¸ì´ 1:1 ìƒë‹´í•˜ëŠ” ê²ƒì²˜ëŸ¼ ê¹Šì´ ìˆê²Œ ë¶„ì„
- ì˜¤í–‰(ëª©í™”í† ê¸ˆìˆ˜), ì‹­ì„±, 12ìš´ì„± ë“± ì „ë¬¸ ìš©ì–´ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©
- "ì™œ ì´ëŸ° ìš´ì„¸ì¸ì§€" ëª…ë¦¬í•™ì  ê·¼ê±°ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…
- ì¼ë°˜ì ì¸ ìš´ì„¸ê°€ ì•„ë‹Œ, ì´ ì‚¬ëŒì˜ ì‚¬ì£¼ì—ë§Œ í•´ë‹¹í•˜ëŠ” ë§ì¶¤ ë¶„ì„

2. í†¤ì•¤ë§¤ë„ˆ
- ì¹œê·¼í•˜ë©´ì„œë„ ì‹ ë¢°ê° ìˆëŠ” í†¤ (ì ì§‘ í• ë¨¸ë‹ˆê°€ ì•„ë‹Œ í˜„ëŒ€ì  ì „ë¬¸ê°€)
- "~ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤" ê°™ì€ AIìŠ¤ëŸ¬ìš´ í‘œí˜„ ì ˆëŒ€ ê¸ˆì§€
- "ë‹¹ì‹ ì˜ ì‚¬ì£¼ë¥¼ ë³´ë‹ˆ...", "ì†”ì§íˆ ë§ì”€ë“œë¦¬ë©´..." ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ í‘œí˜„ ì‚¬ìš©
- ì ì ˆí•œ ê³µê°ê³¼ ê²©ë ¤ë¥¼ í¬í•¨í•˜ë˜ ê·¼ê±° ì—†ëŠ” ì¹­ì°¬ì€ ê¸ˆì§€

3. ì¬ë¯¸ ìš”ì†Œ
- ê° ìš´ì„¸ì— ê³µê°ë˜ëŠ” í¬ì¸íŠ¸ í¬í•¨ ("ì´ ì‹œê¸°ì— íŠ¹íˆ ì¡°ì‹¬í•˜ì„¸ìš”!")
- êµ¬ì²´ì ì¸ ë‚ ì§œë‚˜ ìƒí™© ì˜ˆì‹œ ("3ì›” ë‘˜ì§¸ ì£¼ì— ì˜ˆìƒì¹˜ ëª»í•œ ì¢‹ì€ ì†Œì‹ì´...")
- ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ê³  ì‹¶ì€ í¥ë¯¸ë¡œìš´ ì¸ì‚¬ì´íŠ¸
- ëª…ë¦¬í•™ ê´€ì ì—ì„œì˜ ë…íŠ¹í•œ í•´ì„

4. ì‹¤ìš©ì„±
- ê° ë‹¬ë§ˆë‹¤ êµ¬ì²´ì ìœ¼ë¡œ ë­˜ í•´ì•¼ í•˜ê³  ë­˜ í”¼í•´ì•¼ í•˜ëŠ”ì§€ ëª…í™•íˆ
- ì¶”ìƒì  ì¡°ì–¸ì´ ì•„ë‹Œ ë°”ë¡œ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì  í–‰ë™ ì œì‹œ
- íˆ¬ì, ì´ì§, ê²°í˜¼ ë“± ì¤‘ìš” ê²°ì •ì˜ ìµœì  íƒ€ì´ë° ëª…ì‹œ

5. ë¶„ëŸ‰
- ë°˜ë“œì‹œ 10,000ì ì´ìƒì˜ ë§¤ìš° ìƒì„¸í•œ ë³´ê³ ì„œ
- ê° ì„¹ì…˜ì€ ìµœì†Œ 1,000ì ì´ìƒ
- ì›”ë³„ ìš´ì„¸ëŠ” ê° í•­ëª©ë³„ë¡œ 3ë¬¸ì¥ ì´ìƒ ìƒì„¸íˆ

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:

{
  "summary": {
    "overallFortune": "2025ë…„ ì „ì²´ ìš´ì„¸ ê°œìš” (ìµœì†Œ 500ì)",
    "yearlyTheme": "ì˜¬í•´ì˜ í…Œë§ˆì™€ í‚¤ì›Œë“œ",
    "luckyColor": "í–‰ìš´ì˜ ìƒ‰ìƒ",
    "luckyNumber": "í–‰ìš´ì˜ ìˆ«ì",
    "luckyDirection": "ê¸¸í•œ ë°©í–¥"
  },
  "fourPillars": {
    "year": "ì—°ì£¼ ë¶„ì„",
    "month": "ì›”ì£¼ ë¶„ì„",
    "day": "ì¼ì£¼ ë¶„ì„",
    "time": "ì‹œì£¼ ë¶„ì„",
    "interpretation": "ì‚¬ì£¼íŒ”ì ì¢…í•© í•´ì„ (ìµœì†Œ 1,000ì)"
  },
  "monthlyFortune": {
    "january": {
      "overall": "1ì›” ì „ì²´ ìš´ì„¸",
      "career": "ì§ì—…/ì‚¬ì—…ìš´",
      "love": "ì—°ì• /ê²°í˜¼ìš´",
      "wealth": "ì¬ë¬¼ìš´",
      "health": "ê±´ê°•ìš´",
      "advice": "ì¡°ì–¸",
      "luckyDays": [1, 15, 22],
      "cautionDays": [7, 13]
    },
    "february": { "overall": "...", "career": "...", "love": "...", "wealth": "...", "health": "...", "advice": "...", "luckyDays": [], "cautionDays": [] },
    "march": { "overall": "...", "career": "...", "love": "...", "wealth": "...", "health": "...", "advice": "...", "luckyDays": [], "cautionDays": [] },
    "april": { "overall": "...", "career": "...", "love": "...", "wealth": "...", "health": "...", "advice": "...", "luckyDays": [], "cautionDays": [] },
    "may": { "overall": "...", "career": "...", "love": "...", "wealth": "...", "health": "...", "advice": "...", "luckyDays": [], "cautionDays": [] },
    "june": { "overall": "...", "career": "...", "love": "...", "wealth": "...", "health": "...", "advice": "...", "luckyDays": [], "cautionDays": [] },
    "july": { "overall": "...", "career": "...", "love": "...", "wealth": "...", "health": "...", "advice": "...", "luckyDays": [], "cautionDays": [] },
    "august": { "overall": "...", "career": "...", "love": "...", "wealth": "...", "health": "...", "advice": "...", "luckyDays": [], "cautionDays": [] },
    "september": { "overall": "...", "career": "...", "love": "...", "wealth": "...", "health": "...", "advice": "...", "luckyDays": [], "cautionDays": [] },
    "october": { "overall": "...", "career": "...", "love": "...", "wealth": "...", "health": "...", "advice": "...", "luckyDays": [], "cautionDays": [] },
    "november": { "overall": "...", "career": "...", "love": "...", "wealth": "...", "health": "...", "advice": "...", "luckyDays": [], "cautionDays": [] },
    "december": { "overall": "...", "career": "...", "love": "...", "wealth": "...", "health": "...", "advice": "...", "luckyDays": [], "cautionDays": [] }
  },
  "careerFortune": {
    "overall": "2025ë…„ ì§ì—…ìš´ ì „ì²´ ë¶„ì„ (ìµœì†Œ 1,500ì)",
    "bestMonths": ["3ì›”", "7ì›”", "10ì›”"],
    "cautionMonths": ["5ì›”", "9ì›”"],
    "opportunities": ["ê¸°íšŒ1", "ê¸°íšŒ2", "ê¸°íšŒ3"],
    "challenges": ["ë„ì „1", "ë„ì „2"],
    "advice": "ì§ì—… ê´€ë ¨ ì¡°ì–¸ (ìµœì†Œ 500ì)"
  },
  "wealthFortune": {
    "overall": "2025ë…„ ì¬ë¬¼ìš´ ì „ì²´ ë¶„ì„ (ìµœì†Œ 1,500ì)",
    "investmentAdvice": "íˆ¬ì ê´€ë ¨ ì¡°ì–¸",
    "savingsAdvice": "ì €ì¶• ê´€ë ¨ ì¡°ì–¸",
    "spendingCaution": "ì§€ì¶œ ì£¼ì˜ì‚¬í•­",
    "bestMonths": ["4ì›”", "8ì›”", "11ì›”"],
    "cautionMonths": ["2ì›”", "6ì›”"],
    "luckyNumbers": [3, 7, 12]
  },
  "loveFortune": {
    "overall": "2025ë…„ ì—°ì• ìš´/ê²°í˜¼ìš´ ì „ì²´ ë¶„ì„ (ìµœì†Œ 1,500ì)",
    "single": "ë¯¸í˜¼ìë¥¼ ìœ„í•œ ì¡°ì–¸",
    "relationship": "ì—°ì•  ì¤‘ì¸ ì‚¬ëŒì„ ìœ„í•œ ì¡°ì–¸",
    "married": "ê¸°í˜¼ìë¥¼ ìœ„í•œ ì¡°ì–¸",
    "bestMonths": ["2ì›”", "5ì›”", "9ì›”"],
    "cautionMonths": ["7ì›”", "12ì›”"]
  },
  "healthFortune": {
    "overall": "2025ë…„ ê±´ê°•ìš´ ì „ì²´ ë¶„ì„ (ìµœì†Œ 1,000ì)",
    "weakPoints": ["ì£¼ì˜í•  ì‹ ì²´ ë¶€ìœ„1", "ì£¼ì˜í•  ì‹ ì²´ ë¶€ìœ„2"],
    "preventionAdvice": "ì˜ˆë°©ì„ ìœ„í•œ ì¡°ì–¸",
    "exerciseRecommendation": "ì¶”ì²œ ìš´ë™",
    "dietAdvice": "ì‹ì´ ì¡°ì–¸"
  },
  "relationshipFortune": {
    "family": "ê°€ì¡± ê´€ê³„ ìš´ì„¸ (ìµœì†Œ 500ì)",
    "friends": "ì¹œêµ¬/ì‚¬íšŒ ê´€ê³„ ìš´ì„¸ (ìµœì†Œ 500ì)",
    "colleagues": "ì§ì¥ ë‚´ ì¸ê°„ê´€ê³„ (ìµœì†Œ 500ì)"
  },
  "spiritualGuidance": {
    "meditation": "ëª…ìƒ ë° ë§ˆìŒ ìˆ˜ì–‘ ì¡°ì–¸",
    "luckyCharms": ["ë¶€ì /ì•¡ì„¸ì„œë¦¬ ì¶”ì²œ"],
    "avoidance": ["í”¼í•´ì•¼ í•  ê²ƒë“¤"],
    "rituals": "ê¸¸í•œ ì˜ì‹ì´ë‚˜ ìŠµê´€"
  },
  "yearlyAdvice": "2025ë…„ì„ ìœ„í•œ ì¢…í•© ì¡°ì–¸ (ìµœì†Œ 1,000ì)"
}

ê° ì›”ë³„ ìš´ì„¸ëŠ” ë°˜ë“œì‹œ 6ê°œ í•­ëª©(overall, career, love, wealth, health, advice)ì„ ëª¨ë‘ ìƒì„¸í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.
ëª¨ë“  í…ìŠ¤íŠ¸ëŠ” êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.`;

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.8,
        maxTokens: 8000,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      model: 'gpt-4o-mini',
    };
  } catch (error) {
    console.error('OpenAI Deep Saju 2025 analysis error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Analyze palmistry from hand image (ìˆ˜ìƒ)
 * @param imageUrl - URL or base64 of the hand image
 * @param hand - Which hand (left or right)
 */
export async function analyzePalmistry(imageUrl: string, hand: 'left' | 'right' = 'right') {
  try {
    // Validate if base64 image
    if (imageUrl.startsWith('data:image/')) {
      validateImage(imageUrl);
    }

    const prompt = PALMISTRY_PROMPT(hand);

    const response = await client.vision(imageUrl, prompt, {
      temperature: 0.7,
      maxTokens: 2500,
      responseFormat: 'json',
    });

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      model: 'gpt-4o-mini',
    };
  } catch (error) {
    console.error('OpenAI palmistry error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Analyze horoscope (ë³„ìë¦¬ ìš´ì„¸)
 * @param birthDate - Birth date (YYYY-MM-DD)
 * @param zodiacSign - Optional zodiac sign
 */
export async function analyzeHoroscope(birthDate: string, zodiacSign?: string) {
  try {
    const prompt = HOROSCOPE_PROMPT(birthDate, zodiacSign);

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.7,
        maxTokens: 2000,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      model: 'gpt-4o-mini',
    };
  } catch (error) {
    console.error('OpenAI horoscope error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Analyze Chinese zodiac fortune (ë  ìš´ì„¸)
 * @param birthDate - Birth date (YYYY-MM-DD)
 */
export async function analyzeZodiac(birthDate: string) {
  try {
    const prompt = ZODIAC_PROMPT(birthDate);

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.7,
        maxTokens: 2500,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      model: 'gpt-4o-mini',
    };
  } catch (error) {
    console.error('OpenAI zodiac error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Analyze love compatibility (ì—°ì• ê¶í•©)
 * @param person1BirthDate - Person 1's birth date
 * @param person2BirthDate - Person 2's birth date
 */
export async function analyzeLoveCompatibility(person1BirthDate: string, person2BirthDate: string) {
  try {
    const prompt = LOVE_COMPATIBILITY_PROMPT(person1BirthDate, person2BirthDate);

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.7,
        maxTokens: 2000,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      model: 'gpt-4o-mini',
    };
  } catch (error) {
    console.error('OpenAI love compatibility error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Analyze name compatibility (ì´ë¦„ê¶í•©)
 * @param name1 - Person 1's name
 * @param name2 - Person 2's name
 */
export async function analyzeNameCompatibility(name1: string, name2: string) {
  try {
    const prompt = NAME_COMPATIBILITY_PROMPT(name1, name2);

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.7,
        maxTokens: 2000,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      model: 'gpt-4o-mini',
    };
  } catch (error) {
    console.error('OpenAI name compatibility error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Analyze marriage compatibility (ê²°í˜¼ê¶í•©)
 * @param person1Name - Person 1's name
 * @param person1BirthDate - Person 1's birth date
 * @param person2Name - Person 2's name
 * @param person2BirthDate - Person 2's birth date
 */
export async function analyzeMarriageCompatibility(
  person1Name: string,
  person1BirthDate: string,
  person2Name: string,
  person2BirthDate: string
) {
  try {
    const prompt = MARRIAGE_COMPATIBILITY_PROMPT(person1Name, person1BirthDate, person2Name, person2BirthDate);

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.7,
        maxTokens: 3000,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      model: 'gpt-4o-mini',
    };
  } catch (error) {
    console.error('OpenAI marriage compatibility error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Analyze MBTI with user input and test results
 * @param userInputMBTI - User's self-reported MBTI (or null)
 * @param answers - Array of 28 answers (1-5 scale)
 */
export async function analyzeMBTI(userInputMBTI: string | null, answers: number[]) {
  try {
    // Calculate scores for each axis
    const axisScores = calculateMBTIScores(answers);

    // Determine MBTI type from test
    const testResultMBTI = determineMBTIType(axisScores);

    const prompt = MBTI_ANALYSIS_PROMPT(userInputMBTI, testResultMBTI, axisScores);

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.7,
        maxTokens: 3000,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      testResultMBTI,
      axisScores,
      model: 'gpt-4o-mini',
    };
  } catch (error) {
    console.error('OpenAI MBTI analysis error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Calculate MBTI axis scores from answers
 */
function calculateMBTIScores(answers: number[]) {
  const scores = {
    EI: { E: 0, I: 0 },
    SN: { S: 0, N: 0 },
    TF: { T: 0, F: 0 },
    JP: { J: 0, P: 0 },
  };

  answers.forEach((answer, index) => {
    const question = mbtiQuestions[index];
    const { axis, direction, reverse } = question;

    // Apply reverse scoring if needed (5->1, 4->2, 3->3, 2->4, 1->5)
    let adjustedAnswer = answer;
    if (reverse) {
      adjustedAnswer = 6 - answer;
    }

    // Convert 1-5 scale to score
    // 1 = strongly disagree, 5 = strongly agree
    const score = direction === 'positive' ? adjustedAnswer : (6 - adjustedAnswer);

    if (axis === 'EI') {
      scores.EI.E += score > 3 ? (score - 3) : 0;
      scores.EI.I += score < 3 ? (3 - score) : 0;
    } else if (axis === 'SN') {
      scores.SN.S += score > 3 ? (score - 3) : 0;
      scores.SN.N += score < 3 ? (3 - score) : 0;
    } else if (axis === 'TF') {
      scores.TF.T += score > 3 ? (score - 3) : 0;
      scores.TF.F += score < 3 ? (3 - score) : 0;
    } else if (axis === 'JP') {
      scores.JP.J += score > 3 ? (score - 3) : 0;
      scores.JP.P += score < 3 ? (3 - score) : 0;
    }
  });

  // Convert to percentages
  const normalize = (a: number, b: number) => {
    const total = a + b || 1;
    return {
      first: Math.round((a / total) * 100),
      second: Math.round((b / total) * 100),
    };
  };

  const EI = normalize(scores.EI.E, scores.EI.I);
  const SN = normalize(scores.SN.S, scores.SN.N);
  const TF = normalize(scores.TF.T, scores.TF.F);
  const JP = normalize(scores.JP.J, scores.JP.P);

  return {
    EI: { E: EI.first, I: EI.second },
    SN: { S: SN.first, N: SN.second },
    TF: { T: TF.first, F: TF.second },
    JP: { J: JP.first, P: JP.second },
  };
}

/**
 * Determine MBTI type from axis scores
 */
function determineMBTIType(axisScores: any): string {
  const e_or_i = axisScores.EI.E > axisScores.EI.I ? 'E' : 'I';
  const s_or_n = axisScores.SN.S > axisScores.SN.N ? 'S' : 'N';
  const t_or_f = axisScores.TF.T > axisScores.TF.F ? 'T' : 'F';
  const j_or_p = axisScores.JP.J > axisScores.JP.P ? 'J' : 'P';

  return `${e_or_i}${s_or_n}${t_or_f}${j_or_p}`;
}

/**
 * Analyze Enneagram from test results
 * @param answers - Array of 36 answers (1-5 scale)
 */
export async function analyzeEnneagram(answers: number[]) {
  try {
    // Calculate scores for each type
    const typeScores = calculateEnneagramScores(answers);

    // Determine main type and wing
    const { mainType, wingType } = determineEnneagramType(typeScores);

    const prompt = ENNEAGRAM_ANALYSIS_PROMPT(typeScores, mainType, wingType);

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.7,
        maxTokens: 3000,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      mainType,
      wingType,
      typeScores,
      model: 'gpt-4o-mini',
    };
  } catch (error) {
    console.error('OpenAI Enneagram analysis error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Calculate Enneagram type scores from answers
 */
function calculateEnneagramScores(answers: number[]): { [key: number]: number } {
  const scores: { [key: number]: number } = {
    1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
  };

  answers.forEach((answer, index) => {
    const question = enneagramQuestions[index];
    const { type, reverse } = question;

    // Apply reverse scoring if needed (5->1, 4->2, 3->3, 2->4, 1->5)
    let adjustedAnswer = answer;
    if (reverse) {
      adjustedAnswer = 6 - answer;
    }

    // Add answer score (1-5) to corresponding type
    scores[type] += adjustedAnswer;
  });

  return scores;
}

/**
 * Determine main type and wing from scores
 */
function determineEnneagramType(typeScores: { [key: number]: number }): { mainType: number; wingType: number | null } {
  // Find main type (highest score)
  const sortedTypes = Object.entries(typeScores)
    .sort(([, a], [, b]) => b - a)
    .map(([type]) => parseInt(type));

  const mainType = sortedTypes[0];

  // Determine wing (adjacent type with higher score)
  const adjacentTypes = [
    mainType === 1 ? 9 : mainType - 1,
    mainType === 9 ? 1 : mainType + 1
  ];

  const wingScores = adjacentTypes.map(type => ({
    type,
    score: typeScores[type]
  }));

  wingScores.sort((a, b) => b.score - a.score);

  // Only consider wing if score is significant (at least 70% of main type score)
  const wingType = wingScores[0].score >= typeScores[mainType] * 0.7
    ? wingScores[0].type
    : null;

  return { mainType, wingType };
}

/**
 * Analyze Big Five Personality Test
 */
export async function analyzeBigFive(answers: number[]): Promise<any> {
  try {
    const { bigFiveQuestions } = await import('../data/bigfive-questions.js');

    if (answers.length !== bigFiveQuestions.length) {
      return { success: false, error: 'Invalid number of answers' };
    }

    // Calculate trait scores
    const traitScores = calculateBigFiveScores(answers);

    // Build prompt for AI analysis
    const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ì‹¬ë¦¬í•™ìì…ë‹ˆë‹¤. Big Five ì„±ê²© í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

íŠ¹ì„±ë³„ ì ìˆ˜:
- ê°œë°©ì„± (Openness): ${traitScores.O}ì /25ì 
- ì„±ì‹¤ì„± (Conscientiousness): ${traitScores.C}ì /25ì 
- ì™¸í–¥ì„± (Extraversion): ${traitScores.E}ì /25ì 
- ì¹œí™”ì„± (Agreeableness): ${traitScores.A}ì /25ì 
- ì‹ ê²½ì„± (Neuroticism): ${traitScores.N}ì /25ì 

ë‹¤ìŒ í˜•ì‹ì˜ JSONìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "summary": {
    "overview": "ì¢…í•© ì„±ê²© ë¶„ì„ (2-3ë¬¸ì¥)",
    "dominantTraits": ["ê°€ì¥ ë‘ë“œëŸ¬ì§„ íŠ¹ì„± 1", "íŠ¹ì„± 2"],
    "developmentAreas": ["ë°œì „ì´ í•„ìš”í•œ ì˜ì—­ 1", "ì˜ì—­ 2"]
  },
  "traits": {
    "O": {
      "level": "ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ",
      "description": "ì´ ìˆ˜ì¤€ì˜ ê°œë°©ì„±ì´ ì˜ë¯¸í•˜ëŠ” ë°”",
      "strengths": ["ê°•ì  1", "ê°•ì  2"],
      "challenges": ["ì–´ë ¤ì›€ 1", "ì–´ë ¤ì›€ 2"]
    },
    "C": {
      "level": "ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ",
      "description": "ì´ ìˆ˜ì¤€ì˜ ì„±ì‹¤ì„±ì´ ì˜ë¯¸í•˜ëŠ” ë°”",
      "strengths": ["ê°•ì  1", "ê°•ì  2"],
      "challenges": ["ì–´ë ¤ì›€ 1", "ì–´ë ¤ì›€ 2"]
    },
    "E": {
      "level": "ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ",
      "description": "ì´ ìˆ˜ì¤€ì˜ ì™¸í–¥ì„±ì´ ì˜ë¯¸í•˜ëŠ” ë°”",
      "strengths": ["ê°•ì  1", "ê°•ì  2"],
      "challenges": ["ì–´ë ¤ì›€ 1", "ì–´ë ¤ì›€ 2"]
    },
    "A": {
      "level": "ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ",
      "description": "ì´ ìˆ˜ì¤€ì˜ ì¹œí™”ì„±ì´ ì˜ë¯¸í•˜ëŠ” ë°”",
      "strengths": ["ê°•ì  1", "ê°•ì  2"],
      "challenges": ["ì–´ë ¤ì›€ 1", "ì–´ë ¤ì›€ 2"]
    },
    "N": {
      "level": "ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ",
      "description": "ì´ ìˆ˜ì¤€ì˜ ì‹ ê²½ì„±ì´ ì˜ë¯¸í•˜ëŠ” ë°”",
      "strengths": ["ê°•ì  1", "ê°•ì  2"],
      "challenges": ["ì–´ë ¤ì›€ 1", "ì–´ë ¤ì›€ 2"]
    }
  },
  "career": {
    "suitableFields": ["ì í•©í•œ ë¶„ì•¼ 1", "ë¶„ì•¼ 2", "ë¶„ì•¼ 3"],
    "workStyle": "ì—…ë¬´ ìŠ¤íƒ€ì¼ ì„¤ëª…",
    "teamRole": "íŒ€ ë‚´ ì—­í• "
  },
  "relationships": {
    "interpersonalStyle": "ëŒ€ì¸ê´€ê³„ ìŠ¤íƒ€ì¼",
    "communicationTips": ["ì˜ì‚¬ì†Œí†µ íŒ 1", "íŒ 2"],
    "compatibilityNotes": "ê¶í•© ê´€ë ¨ ì¡°ì–¸"
  },
  "growth": {
    "recommendations": ["ì„±ì¥ì„ ìœ„í•œ ì¶”ì²œì‚¬í•­ 1", "ì¶”ì²œì‚¬í•­ 2", "ì¶”ì²œì‚¬í•­ 3"],
    "balanceTips": ["ê· í˜•ì„ ìœ„í•œ ì¡°ì–¸ 1", "ì¡°ì–¸ 2"]
  }
}`;

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.7,
        maxTokens: 2500,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      traitScores,
      model: 'gpt-4o-mini'
    };
  } catch (error) {
    console.error('Big Five analysis error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    };
  }
}

/**
 * Calculate Big Five trait scores
 */
function calculateBigFiveScores(answers: number[]): { [key: string]: number } {
  const scores: { [key: string]: number } = {
    O: 0, C: 0, E: 0, A: 0, N: 0
  };

  bigFiveQuestions.forEach((q, index) => {
    const answer = answers[index];

    // Apply reverse scoring if needed (5->1, 4->2, 3->3, 2->4, 1->5)
    let adjustedAnswer = answer;
    if (q.reverse) {
      adjustedAnswer = 6 - answer;
    }

    // positive direction: answer as is, negative direction: inverted (6 - answer)
    const score = q.direction === 'positive' ? adjustedAnswer : (6 - adjustedAnswer);
    scores[q.trait] += score;
  });

  return scores;
}

/**
 * Analyze Stress Level
 */
export async function analyzeStress(answers: number[]): Promise<any> {
  try {
    const { stressQuestions } = await import('../data/stress-questions.js');

    if (answers.length !== stressQuestions.length) {
      return { success: false, error: 'Invalid number of answers' };
    }

    // Calculate category scores and overall stress
    const categoryScores = calculateStressScores(answers);
    const totalScore = Object.values(categoryScores).reduce((sum, score) => sum + score, 0);
    const overallStressLevel = Math.round((totalScore / (answers.length * 5)) * 100);

    // Build prompt for AI analysis
    const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ì‹¬ë¦¬ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜ ì¸¡ì • ê²°ê³¼ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

ì „ì²´ ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€: ${overallStressLevel}% (${totalScore}ì /${answers.length * 5}ì )

ì˜ì—­ë³„ ì ìˆ˜:
- ì—…ë¬´/ì»¤ë¦¬ì–´: ${categoryScores.work}ì /25ì 
- ëŒ€ì¸ê´€ê³„: ${categoryScores.relationships}ì /25ì 
- ê±´ê°•: ${categoryScores.health}ì /25ì 
- ì¼ìƒìƒí™œ: ${categoryScores.life}ì /25ì 

ë‹¤ìŒ í˜•ì‹ì˜ JSONìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "overallAssessment": {
    "level": "ë§¤ìš° ë†’ìŒ/ë†’ìŒ/ë³´í†µ/ë‚®ìŒ/ë§¤ìš° ë‚®ìŒ",
    "description": "ì „ë°˜ì ì¸ ìŠ¤íŠ¸ë ˆìŠ¤ ìƒíƒœ ì„¤ëª… (2-3ë¬¸ì¥)",
    "riskFactors": ["ì£¼ìš” ìœ„í—˜ ìš”ì¸ 1", "ìš”ì¸ 2"]
  },
  "categories": {
    "work": {
      "level": "ë†’ìŒ/ë³´í†µ/ë‚®ìŒ",
      "analysis": "ì—…ë¬´ ìŠ¤íŠ¸ë ˆìŠ¤ ë¶„ì„",
      "concerns": ["ìš°ë ¤ì‚¬í•­ 1", "ìš°ë ¤ì‚¬í•­ 2"],
      "tips": ["ëŒ€ì²˜ ë°©ë²• 1", "ë°©ë²• 2"]
    },
    "relationships": {
      "level": "ë†’ìŒ/ë³´í†µ/ë‚®ìŒ",
      "analysis": "ëŒ€ì¸ê´€ê³„ ìŠ¤íŠ¸ë ˆìŠ¤ ë¶„ì„",
      "concerns": ["ìš°ë ¤ì‚¬í•­ 1", "ìš°ë ¤ì‚¬í•­ 2"],
      "tips": ["ëŒ€ì²˜ ë°©ë²• 1", "ë°©ë²• 2"]
    },
    "health": {
      "level": "ë†’ìŒ/ë³´í†µ/ë‚®ìŒ",
      "analysis": "ê±´ê°• ê´€ë ¨ ìŠ¤íŠ¸ë ˆìŠ¤ ë¶„ì„",
      "concerns": ["ìš°ë ¤ì‚¬í•­ 1", "ìš°ë ¤ì‚¬í•­ 2"],
      "tips": ["ëŒ€ì²˜ ë°©ë²• 1", "ë°©ë²• 2"]
    },
    "life": {
      "level": "ë†’ìŒ/ë³´í†µ/ë‚®ìŒ",
      "analysis": "ì¼ìƒìƒí™œ ìŠ¤íŠ¸ë ˆìŠ¤ ë¶„ì„",
      "concerns": ["ìš°ë ¤ì‚¬í•­ 1", "ìš°ë ¤ì‚¬í•­ 2"],
      "tips": ["ëŒ€ì²˜ ë°©ë²• 1", "ë°©ë²• 2"]
    }
  },
  "management": {
    "immediatePriorities": ["ì¦‰ì‹œ ëŒ€ì²˜í•  ì‚¬í•­ 1", "ì‚¬í•­ 2", "ì‚¬í•­ 3"],
    "copingStrategies": ["ëŒ€ì²˜ ì „ëµ 1", "ì „ëµ 2", "ì „ëµ 3"],
    "relaxationTechniques": ["ì´ì™„ ê¸°ë²• 1", "ê¸°ë²• 2"],
    "lifestyleChanges": ["ìƒí™œìŠµê´€ ê°œì„  1", "ê°œì„  2"]
  },
  "resources": {
    "professionalHelp": "ì „ë¬¸ê°€ ë„ì›€ì´ í•„ìš”í•œì§€ ì—¬ë¶€ì™€ ì´ìœ ",
    "supportSystems": ["í™œìš© ê°€ëŠ¥í•œ ì§€ì› ì²´ê³„ 1", "ì²´ê³„ 2"],
    "selfCareActivities": ["ìê¸°ê´€ë¦¬ í™œë™ 1", "í™œë™ 2", "í™œë™ 3"]
  }
}`;

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.7,
        maxTokens: 2500,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      overallStressLevel,
      categoryScores,
      model: 'gpt-4o-mini'
    };
  } catch (error) {
    console.error('Stress analysis error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    };
  }
}

/**
 * Calculate stress scores by category
 */
function calculateStressScores(answers: number[]): { [key: string]: number } {
  const scores: { [key: string]: number } = {
    work: 0,
    relationships: 0,
    health: 0,
    life: 0
  };

  stressQuestions.forEach((q, index) => {
    const answer = answers[index];

    // Apply reverse scoring if needed (5->1, 4->2, 3->3, 2->4, 1->5)
    let adjustedAnswer = answer;
    if (q.reverse) {
      adjustedAnswer = 6 - answer;
    }

    scores[q.category] += adjustedAnswer;
  });

  return scores;
}

/**
 * Analyze Geumjjoki (ê¸ˆìª½ì´) test
 */
export async function analyzeGeumjjoki(answers: number[]): Promise<any> {
  try {
    const categoryScores = calculateGeumjjokiScores(answers);

    // Calculate total score (0-100)
    const totalAnswers = answers.reduce((sum, answer) => sum + answer, 0);
    const maxScore = answers.length * 5; // 30 questions * 5 max score
    const geumjjokiScore = Math.round((totalAnswers / maxScore) * 100);

    // Determine grade
    const grade = getGeumjjokiGrade(geumjjokiScore);

    const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ì‹¬ë¦¬í•™ìì…ë‹ˆë‹¤. "ê¸ˆìª½ì´ í…ŒìŠ¤íŠ¸" ê²°ê³¼ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

ê¸ˆìª½ì´ í…ŒìŠ¤íŠ¸ëŠ” 10-30ëŒ€ê°€ ìì‹ ì˜ ì¼ìƒ ì† í–‰ë™ íŒ¨í„´ê³¼ ìŠµê´€ì„ ì¬ë¯¸ìˆê²Œ ì§„ë‹¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.

**ê¸ˆìª½ì´ ì§€ìˆ˜**: ${geumjjokiScore}ì /100ì 
**ë“±ê¸‰**: ${grade.name} ${grade.emoji}

**ì¹´í…Œê³ ë¦¬ë³„ ì ìˆ˜**:
- ì¶©ë™ì„±/ìê¸°ì¡°ì ˆ: ${categoryScores.impulse}ì /30ì 
- ì§‘ì¤‘ë ¥/ê³„íšì„±: ${categoryScores.focus}ì /30ì 
- ê°ì •ì¡°ì ˆ/ëŒ€ì¸ê´€ê³„: ${categoryScores.emotion}ì /30ì 
- ìƒí™œìŠµê´€/ì±…ì„ê°: ${categoryScores.lifestyle}ì /30ì 
- ë””ì§€í„¸/SNS ìŠµê´€: ${categoryScores.digital}ì /30ì 

ë‹¤ìŒ í˜•ì‹ì˜ JSONìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "summary": {
    "gradeDescription": "${grade.description}",
    "mainType": "ë‹¹ì‹ ì˜ ê¸ˆìª½ì´ ìœ í˜• (ex: ì¶©ë™í˜• ê¸ˆìª½ì´, ë¯¸ë£¨ê¸°í˜• ê¸ˆìª½ì´)",
    "oneLineComment": "ì¬ë¯¸ìˆê³  ê³µê°ë˜ëŠ” í•œ ì¤„ ì½”ë©˜íŠ¸"
  },
  "categoryAnalysis": {
    "impulse": {
      "level": "ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ",
      "characteristics": ["íŠ¹ì§•1", "íŠ¹ì§•2", "íŠ¹ì§•3"],
      "impact": "ì¼ìƒì— ë¯¸ì¹˜ëŠ” ì˜í–¥"
    },
    "focus": { /* ë™ì¼í•œ êµ¬ì¡° */ },
    "emotion": { /* ë™ì¼í•œ êµ¬ì¡° */ },
    "lifestyle": { /* ë™ì¼í•œ êµ¬ì¡° */ },
    "digital": { /* ë™ì¼í•œ êµ¬ì¡° */ }
  },
  "strengths": ["ê°•ì 1 (ê¸ì •ì ìœ¼ë¡œ)", "ê°•ì 2", "ê°•ì 3"],
  "challenges": ["ê°œì„ ì´ í•„ìš”í•œ ìŠµê´€1", "ìŠµê´€2", "ìŠµê´€3"],
  "improvement": {
    "priority": ["ìµœìš°ì„  ê°œì„ ì‚¬í•­ TOP 3"],
    "tips": ["ì‹¤ì²œ ê°€ëŠ¥í•œ íŒ1", "íŒ2", "íŒ3"],
    "encouragement": "ê³µê°ê³¼ ìœ„ë¡œì˜ ë©”ì‹œì§€"
  },
  "forOthers": {
    "howTheyFeel": "ì£¼ë³€ ì‚¬ëŒë“¤ì´ ëŠë¼ëŠ” ì ",
    "advice": "ì£¼ë³€ ì‚¬ëŒë“¤ì„ ìœ„í•œ ì¡°ì–¸"
  }
}

ì¬ë¯¸ìˆê³  ê³µê°ë˜ëŠ” í†¤ìœ¼ë¡œ, í•˜ì§€ë§Œ ì‹¤ì§ˆì ì¸ ë„ì›€ì´ ë˜ëŠ” ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”.`;

    const response = await client.chat(
      [{ role: 'user', content: prompt }],
      {
        temperature: 0.7,
        maxTokens: 3000,
        responseFormat: 'json',
      }
    );

    const analysis = client.parseJSON(response.content);

    return {
      success: true,
      analysis,
      geumjjokiScore,
      grade: {
        name: grade.name,
        emoji: grade.emoji,
        description: grade.description
      },
      categoryScores,
      model: 'gpt-4o-mini'
    };
  } catch (error) {
    console.error('Geumjjoki analysis error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    };
  }
}

/**
 * Calculate geumjjoki scores by category
 */
function calculateGeumjjokiScores(answers: number[]): { [key: string]: number } {
  const scores: { [key: string]: number } = {
    impulse: 0,
    focus: 0,
    emotion: 0,
    lifestyle: 0,
    digital: 0
  };

  geumjjokiQuestions.forEach((q, index) => {
    const answer = answers[index];

    // Apply reverse scoring if needed (5->1, 4->2, 3->3, 2->4, 1->5)
    let adjustedAnswer = answer;
    if (q.reverse) {
      adjustedAnswer = 6 - answer;
    }

    scores[q.category] += adjustedAnswer;
  });

  return scores;
}

/**
 * Get grade info based on score
 */
function getGeumjjokiGrade(score: number): { name: string; emoji: string; description: string } {
  for (const [key, gradeInfo] of Object.entries(GRADE_INFO)) {
    const [min, max] = gradeInfo.range;
    if (score >= min && score <= max) {
      return {
        name: gradeInfo.name,
        emoji: gradeInfo.emoji,
        description: gradeInfo.description
      };
    }
  }
  // Default to normal if no match
  return {
    name: GRADE_INFO.normal.name,
    emoji: GRADE_INFO.normal.emoji,
    description: GRADE_INFO.normal.description
  };
}

/**
 * Deep Fortune 2025 - 2025ë…„ ì‹¬ì¸µ ì‹ ë…„ìš´ì„¸
 * Generates comprehensive year-long fortune reading
 */
export async function analyzeDeepFortune2025(birthDate: string, birthTime?: string, gender?: 'male' | 'female') {
  try {
    const prompt = `ë‹¹ì‹ ì€ í•œêµ­ì˜ ì‚¬ì£¼ ë° ìš´ì„¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 2025ë…„(ì„ì‚¬ë…„, ë±€ë ) ì‹ ë…„ì„ ë§ì•„ ìƒì„¸í•œ 1ë…„ ìš´ì„¸ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

ìƒë…„ì›”ì¼: ${birthDate}
${birthTime ? `íƒœì–´ë‚œ ì‹œê°„: ${birthTime}` : ''}
${gender ? `ì„±ë³„: ${gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}` : ''}

ë‹¤ìŒ ë‚´ìš©ì„ ë§¤ìš° ìƒì„¸í•˜ê²Œ ë¶„ì„í•´ì£¼ì„¸ìš” (ì´ 5,000-10,000ì ë¶„ëŸ‰):

# 1. 2025ë…„ ì „ì²´ ìš´ì„¸ ê°œê´€
- ì„ì‚¬ë…„ì˜ ê¸°ìš´ê³¼ ê·€í•˜ì˜ ì‚¬ì£¼ì™€ì˜ ì¡°í™”
- ì „ë°˜ì ì¸ ìš´ì˜ íë¦„ (ìƒìŠ¹/í•˜ê°•/í‰íƒ„)
- ì˜¬í•´ì˜ í•µì‹¬ í‚¤ì›Œë“œ 3ê°€ì§€
- ê°€ì¥ ì£¼ì˜í•´ì•¼ í•  ì‹œê¸°ì™€ ê°€ì¥ ì¢‹ì€ ì‹œê¸°

# 2. ì›”ë³„ ìƒì„¸ ìš´ì„¸ (1ì›” ~ 12ì›”)
ê° ì›”ë§ˆë‹¤ ë‹¤ìŒ í•­ëª©ì„ í¬í•¨:
- í•´ë‹¹ ì›”ì˜ ì „ì²´ ìš´ì„¸ íë¦„
- ì£¼ìš” ì´ë²¤íŠ¸ ë° ê¸°íšŒ
- ì£¼ì˜í•  ì 
- ì¶”ì²œ í™œë™

# 3. ì„¸ë¶€ ìš´ì„¸ ë¶„ì„

## 3.1 ì¬ë¬¼ìš´ (è²¡é‹)
- ìˆ˜ì… ì „ë§ ë° ë³€ë™ì„±
- íˆ¬ì ìš´ì„¸ (ë¶€ë™ì‚°, ì£¼ì‹, ì‚¬ì—… ë“±)
- ì§€ì¶œ ì£¼ì˜ì‚¬í•­
- ì¬í…Œí¬ ì¶”ì²œ ë°©í–¥
- í° ëˆì´ ë“¤ì–´ì˜¤ëŠ” ì‹œê¸°
- ì¬ë¬¼ ì†ì‹¤ ì£¼ì˜ ì‹œê¸°

## 3.2 ì§ì¥ìš´ / ì‚¬ì—…ìš´ (äº‹æ¥­é‹)
- ì§ì¥ì¸: ìŠ¹ì§„, í‰ê°€, ì´ì§ ìš´ì„¸
- ì‚¬ì—…ì: ë§¤ì¶œ, í™•ì¥, ê³„ì•½ ìš´ì„¸
- ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ ì‹œì‘ ê¸¸ì¼
- ì£¼ì˜í•´ì•¼ í•  ê°ˆë“± ìš”ì†Œ
- í˜‘ë ¥ì ë° ë™ì—… ìš´ì„¸

## 3.3 ì—°ì• ìš´ / ê²°í˜¼ìš´ (æˆ€æ„›é‹)
- ì†”ë¡œ: ë§Œë‚¨ì˜ ê¸°íšŒ, ì†Œê°œíŒ… ìš´, ìµœì ì˜ ë§Œë‚¨ ì‹œê¸°
- ì—°ì¸: ê´€ê³„ ë°œì „, ê²°í˜¼ íƒ€ì´ë°, ê°ˆë“± ì£¼ì˜ ì‹œê¸°
- ê¸°í˜¼: ë¶€ë¶€ ê´€ê³„, ê°€ì •ì˜ í™”ëª©, ì£¼ì˜ì‚¬í•­
- ì´ì„±ì—ê²Œ ë§¤ë ¥ì ìœ¼ë¡œ ë³´ì´ëŠ” ì‹œê¸°

## 3.4 ê±´ê°•ìš´ (å¥åº·é‹)
- ì „ë°˜ì ì¸ ê±´ê°• ìƒíƒœ
- ì£¼ì˜í•´ì•¼ í•  ì‹ ì²´ ë¶€ìœ„
- ì·¨ì•½í•œ ì‹œê¸°ì™€ ê´€ë¦¬ë²•
- ê¶Œì¥ ìš´ë™ ë° ì‹ìŠµê´€
- ì •ê¸° ê²€ì§„ ì¶”ì²œ ì‹œê¸°

## 3.5 í•™ì—…ìš´ / ì‹œí—˜ìš´ (å­¸æ¥­é‹)
- í•™ìŠµ ëŠ¥ë¥ ì´ ì˜¤ë¥´ëŠ” ì‹œê¸°
- ì‹œí—˜ ìš´ì„¸ (ì…ì‹œ, ìê²©ì¦, ìŠ¹ì§„ì‹œí—˜ ë“±)
- ì§‘ì¤‘ë ¥ í–¥ìƒ ë°©ë²•
- ê³µë¶€ ë°©í–¥ ë° ê³¼ëª© ì¶”ì²œ

## 3.6 ëŒ€ì¸ê´€ê³„ìš´ (å°äººé—œä¿‚é‹)
- ì¸ê°„ê´€ê³„ ì „ë°˜ì˜ íë¦„
- ìƒˆë¡œìš´ ì¸ì—°ì˜ ì‹œê¸°
- ê°ˆë“± ì£¼ì˜ ì¸ë¬¼ ìœ í˜•
- ê·€ì¸ìš´ (ë„ì›€ ë°›ì„ ì‚¬ëŒ)
- ë„¤íŠ¸ì›Œí‚¹ ìµœì  ì‹œê¸°

# 4. ê¸¸ë°©ìœ„ ë° ê¸¸ì¼
- 2025ë…„ ê·€í•˜ì—ê²Œ ì¢‹ì€ ë°©ìœ„
- ì´ì‚¬, ì—¬í–‰ ê¸¸ë°©ìœ„
- ì¤‘ìš”í•œ ì¼ì„ ì‹œì‘í•˜ê¸° ì¢‹ì€ ë‚ ë“¤
- í”¼í•´ì•¼ í•  í‰ì¼

# 5. í–‰ìš´ ìš”ì†Œ
- í–‰ìš´ì˜ ìˆ«ì
- í–‰ìš´ì˜ ìƒ‰ìƒ
- í–‰ìš´ì˜ ì•„ì´í…œ
- í–‰ìš´ì„ ë¶€ë¥´ëŠ” ìŠµê´€

# 6. 2025ë…„ ì‹¤ì²œ ì¡°ì–¸
- ë°˜ë“œì‹œ í•´ì•¼ í•  ì¼ TOP 3
- ì ˆëŒ€ í•´ì„œëŠ” ì•ˆ ë  ì¼ TOP 3
- ê· í˜• ì¡íŒ í•œ í•´ë¥¼ ìœ„í•œ ì¡°ì–¸
- ì˜ì /ì •ì‹ ì  ì„±ì¥ ë°©ë²•

# 7. 10ë…„ ìš´ì„¸ ë§¥ë½
- ì§€ë‚œ 2024ë…„ ë³µê¸°
- 2025ë…„ì˜ ìœ„ì¹˜
- í–¥í›„ 2026-2027ë…„ ì „ë§

ë§¤ìš° ìƒì„¸í•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ì¶”ìƒì ì¸ í‘œí˜„ë³´ë‹¤ëŠ” ì‹¤ì§ˆì ì¸ ì¡°ì–¸ì„ ì œê³µí•´ì£¼ì„¸ìš”.

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "year": 2025,
  "overview": {
    "yearEnergy": "ì„ì‚¬ë…„ ê¸°ìš´ ì„¤ëª…",
    "trend": "ìƒìŠ¹/í•˜ê°•/í‰íƒ„",
    "keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3"],
    "bestPeriod": "ê°€ì¥ ì¢‹ì€ ì‹œê¸°",
    "cautionPeriod": "ì£¼ì˜í•  ì‹œê¸°"
  },
  "monthlyFortune": [
    {
      "month": 1,
      "overall": "ì „ì²´ ìš´ì„¸",
      "events": ["ì£¼ìš” ì´ë²¤íŠ¸"],
      "cautions": ["ì£¼ì˜ì‚¬í•­"],
      "recommendations": ["ì¶”ì²œ í™œë™"]
    }
  ],
  "detailedFortune": {
    "wealth": {
      "income": "ìˆ˜ì… ì „ë§",
      "investment": "íˆ¬ì ìš´ì„¸",
      "spending": "ì§€ì¶œ ì£¼ì˜",
      "advice": "ì¬í…Œí¬ ì¡°ì–¸",
      "luckyMonths": [ì¢‹ì€ ë‹¬ë“¤],
      "cautiousMonths": [ì£¼ì˜í•  ë‹¬ë“¤]
    },
    "career": {
      "employee": "ì§ì¥ì¸ ìš´ì„¸",
      "business": "ì‚¬ì—…ì ìš´ì„¸",
      "projectTiming": "í”„ë¡œì íŠ¸ ì‹œì‘ ì‹œê¸°",
      "conflicts": "ê°ˆë“± ìš”ì†Œ",
      "partnership": "í˜‘ë ¥ ìš´ì„¸"
    },
    "love": {
      "single": "ì†”ë¡œ ìš´ì„¸",
      "dating": "ì—°ì¸ ìš´ì„¸",
      "married": "ê¸°í˜¼ ìš´ì„¸",
      "bestMonths": [ì¢‹ì€ ë‹¬ë“¤]
    },
    "health": {
      "overall": "ì „ë°˜ì  ê±´ê°•",
      "vulnerableAreas": ["ì£¼ì˜ ë¶€ìœ„"],
      "riskPeriods": ["ì·¨ì•½ ì‹œê¸°"],
      "recommendations": ["ê¶Œì¥ ì‚¬í•­"],
      "checkupTiming": "ê²€ì§„ ì¶”ì²œ ì‹œê¸°"
    },
    "study": {
      "productivity": "í•™ìŠµ ëŠ¥ë¥  ì‹œê¸°",
      "examLuck": "ì‹œí—˜ ìš´ì„¸",
      "focus": "ì§‘ì¤‘ë ¥ í–¥ìƒë²•",
      "subjects": ["ì¶”ì²œ ê³¼ëª©/ë¶„ì•¼"]
    },
    "relationships": {
      "trend": "ì¸ê°„ê´€ê³„ íë¦„",
      "newConnections": "ìƒˆ ì¸ì—° ì‹œê¸°",
      "conflicts": "ê°ˆë“± ì£¼ì˜",
      "benefactors": "ê·€ì¸ìš´",
      "networking": "ë„¤íŠ¸ì›Œí‚¹ ì‹œê¸°"
    }
  },
  "luckyDirections": {
    "favorable": ["ì¢‹ì€ ë°©ìœ„"],
    "moving": "ì´ì‚¬ ë°©ìœ„",
    "travel": "ì—¬í–‰ ë°©ìœ„",
    "avoid": ["í”¼í•  ë°©ìœ„"]
  },
  "luckyElements": {
    "numbers": [í–‰ìš´ ìˆ«ìë“¤],
    "colors": ["í–‰ìš´ ìƒ‰ìƒë“¤"],
    "items": ["í–‰ìš´ ì•„ì´í…œë“¤"],
    "habits": ["í–‰ìš´ ìŠµê´€ë“¤"]
  },
  "actionAdvice": {
    "mustDo": ["í•´ì•¼ í•  ì¼ 3ê°€ì§€"],
    "mustAvoid": ["í”¼í•´ì•¼ í•  ì¼ 3ê°€ì§€"],
    "balance": "ê· í˜• ì¡°ì–¸",
    "growth": "ì„±ì¥ ë°©ë²•"
  },
  "decadePerspective": {
    "past2024": "2024ë…„ ë³µê¸°",
    "current2025": "2025ë…„ ìœ„ì¹˜",
    "future": "2026-2027 ì „ë§"
  }
}`;

    const result = await client.generateText(prompt, {
      temperature: 0.7,
      max_tokens: 16000, // Allow for very long response
    });

    return {
      success: true,
      analysis: result.content,
      model: 'gpt-4o'
    };
  } catch (error) {
    console.error('Deep Fortune 2025 analysis error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    };
  }
}

export default {
  analyzeFaceReading,
  analyzeFaceReadingFromBase64,
  analyzeSaju,
  analyzePalmistry,
  analyzeHoroscope,
  analyzeZodiac,
  analyzeLoveCompatibility,
  analyzeNameCompatibility,
  analyzeMarriageCompatibility,
  analyzeMBTI,
  analyzeEnneagram,
  analyzeBigFive,
  analyzeStress,
  analyzeGeumjjoki,
  analyzeDeepFortune2025,
};
